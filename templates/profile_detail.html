{% extends 'base.html' %}

{% block title %}
ëª¨ì•„ëª¨ì•„ :: ë˜‘ë˜‘í•œ ìš©ëˆ ê´€ë¦¬ ìŠµê´€
{% endblock %}
{% block content %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="{{ static('css/profile_detail.css') }}?var=0.0.1" />
<!-- jQueryì™€ jQuery UI ì¶”ê°€ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<style>
  .container {
    height: 100vh;
    overflow-y: auto;
  }
</style>

<div class="container">
  <!-- Greeting -->
  <div class="greeting">
    <!-- <h4>ì•ˆë…•í•˜ì„¸ìš”.<br /><span class="childname">ì•„ì´ì´ë¦„</span> ìë…€ì˜ ë¶€ëª¨ë‹˜!</h4> -->
    <h4>ì•ˆë…•í•˜ì„¸ìš”. ë¶€ëª¨ë‹˜!</h4>
  </div>

  <!-- ë…„ì›” ì„ íƒ ì…ë ¥ í•„ë“œ -->
  <div class="d-flex justify-content-center mb-3">
    <select id="year-picker" class="form-select w-auto"
      style="background-color: rgb(255, 252, 241); border-color: #FFCD00;">ë…„</select>
    <select id="month-picker" class="form-select w-auto ms-2"
      style="background-color: rgb(255, 252, 241); border-color: #FFCD00;">ì›”</select>
  </div>

  <!-- Profile Card -->
  <div class="profile-card">
    <!-- <img src="#" class="childavatar" alt="Child Avatar" /> -->
    <div class="profile-info">
      <!-- <h5><span class="childname2">ë‹¤ëª¨ì•„</span> ë§Œ <span class="age"></span>ì„¸</h5> -->
      <!-- <p>í˜„ì¬ ì”ì•¡: <span class="current-amount"></span></p> -->
      <h5>í˜„ì¬ ì”ì•¡: <span class="current-amount"></span></h5>
    </div>
  </div>

  <div class="summery-container">
    <!-- Spending Summary -->
    <p class="summaryview">
      <!-- <span class="summarymonth"></span>ì›” <span class="summaryname"></span> ìë…€ì˜ ì†Œë¹„ -->
      <span class="summarymonth"></span>ì›” ìë…€ì˜ ì†Œë¹„
    </p>
    <div class="d-flex justify-content-between align-items-start spending-summary-container">
      <!-- Pie Chart (ì™¼ìª½) -->
      <div class="spending-chart">
        <div id="pie-chart"></div>
      </div>

      <!-- Maximum Expenditure Box (ì˜¤ë¥¸ìª½) -->
      <div class="max-expenditure-container">
        <div class="max-expenditure-box">
          <p>ì´ë²ˆ ë‹¬ ìµœëŒ€ ì†Œë¹„</p>
          <div class="category-box">
            <strong class="maximumconsumption"></strong>
          </div>
        </div>
        <!-- íˆ¬ëª… ë°•ìŠ¤ -->
        <div class="transparent-box">
          <p>
            <span class="darkpink">â¦</span>ìŒì‹
            <span class="apricot">â¦</span>ìŒë£Œ/ê°„ì‹
            <span class="yellow">â¦</span>ë¬¸êµ¬/ì™„êµ¬<br />
            <span class="green">â¦</span>êµí†µ
            <span class="sky">â¦</span>ë¬¸í™”/ì—¬ê°€
            <span class="pink">â¦</span>ì„ ë¬¼<br />
            <span class="teal">â¦</span>ì €ì¶•
            <span class="lavender">â¦</span>ê¸°íƒ€/ì§€ì¶œ
          </p>
        </div>
      </div>
    </div>

    <!-- Spending Info (ì•„ë˜ì— ë°°ì¹˜) -->
    <div class="spending-summary">
      <div class="spending-info">
        <!-- <p>ì´ ìˆ˜ì…: <span class="totalincome">0</span>ì›</p>
        <p>ì´ ì§€ì¶œ: <span class="totalexpenses">0</span>ì›</p>
        <p>ë‚¨ì€ ê¸ˆì•¡: <span class="remainingamount">0</span>ì›</p> -->
        <p>
          ì´ ìˆ˜ì…: <span class="totalincome">0</span>ì›
          ì´ ì§€ì¶œ: <span class="totalexpenses">0</span>ì›
          ë‚¨ì€ ê¸ˆì•¡: <span class="remainingamount">0</span>ì›
        </p>
      </div>
    </div>

    <!-- ë¡œë”© ë©”ì‹œì§€ì™€ í”„ë¡œê·¸ë˜ìŠ¤ ë°”ë¥¼ ë‹´ì„ ì»¨í…Œì´ë„ˆ -->
    <div class="spending-summary-red"></div>
    <div class="loading-container" id="loading-container" style="display: none;">
      <div class="progress" role="progressbar" aria-label="Loading" aria-valuenow="0" aria-valuemin="0"
        aria-valuemax="100" style="height: 20px;">
        <div class="progress-bar bg-warning text-dark" id="progress-bar" style="width: 0%; font-weight: bold;">0%</div>
      </div>
    </div>

    <!-- Evaluation -->
    <div class="evaluation">
      <h6>ëª¨ì•„ëª¨ì•„ì˜ í•œë§ˆë””âœï¸</h6>
      <p class="evaluationmsg"></p>
    </div>

    <!-- Suggestions -->
    <!-- <div class="suggestions">
      <h6>ì•„ì´ì—ê²Œ ë³´ë‚´ëŠ” í•œ ë§ˆë””
        <img src="{{ static('images/message_icon.png') }}" id="edit-icon"
          style="cursor: pointer; width: 24px; height: 24px; display: inline-block; margin-left: 5px;" alt="Edit Icon">
      </h6>
      <div class="encouragement-message"></div>
      <div id="encouragement-input" style="display: none;">
        <textarea id="edit-encouragement" placeholder="ì•„ì´ì—ê²Œ ë³´ë‚¼ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." class="custom-textarea"></textarea><br>
        <button id="save-encouragement">ë³´ë‚´ê¸°</button>
      </div>
    </div> -->
  </div>
  {% endblock %}

  {% block extra_script %}
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      function getChildId() {
        const pathParts = window.location.pathname.split('/').filter(p => p);
        // /profile/123/ í˜•ì‹ì¸ ê²½ìš°
        if (pathParts.length >= 2 && pathParts[0] === 'profile' && !isNaN(pathParts[1])) {
          return pathParts[1];
        }
        // /profile/?child_id=123 í˜•ì‹ì¸ ê²½ìš°
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('child_id');
      }
      const id = getChildId();

      // ë…„/ì›” ì„ íƒ ê¸°ë³¸ê°’ ì„¤ì •
      const yearPicker = document.getElementById('year-picker')
      const monthPicker = document.getElementById('month-picker')
      let availableYears = {} // ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë…„ë„ë¥¼ ì €ì¥í•  ê°ì²´

      // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ì„¤ì •
      const categoryColors = {
        'ìŒì‹': '#FF9999',
        'ìŒë£Œ/ê°„ì‹': '#FFB76F',
        'ë¬¸êµ¬/ì™„êµ¬': '#FDEA3B',
        'êµí†µ': '#7BEF7B',
        'ë¬¸í™”/ì—¬ê°€': '#99CCFF',
        'ì„ ë¬¼': '#FF99CC',
        'ì €ì¶•': '#21FFFF',
        'ê¸°íƒ€': '#CC99FF'
      }

      // ìµœëŒ€ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateMaxExpenditureBox(category) {
        const categoryElement = document.querySelector('.maximumconsumption')
        if (!categoryElement) return;
        const color = categoryColors[category] || '#000' // ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ìƒ‰ìƒ ì„¤ì • (ì—†ì„ ê²½ìš° ê¸°ë³¸ ê²€ì •ìƒ‰)
        categoryElement.textContent = category
        categoryElement.style.color = color // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì ìš©
      }

      // ì›” ì„ íƒ í•­ëª© ìƒì„± (1~12ì›” ê³ ì •)
      function populateMonthPicker() {
        monthPicker.innerHTML = ''
        for (let i = 1; i <= 12; i++) {
          const option = document.createElement('option')
          option.value = i.toString().padStart(2, '0')
          option.textContent = i + 'ì›”'
          monthPicker.appendChild(option)
        }
      }

      // ì‚¬ìš© ê°€ëŠ¥í•œ ë…„/ì›” ê°€ì ¸ì˜¤ê¸°
      fetch(`/api/v1/diary/${id}/available-months/`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
      })
        .then((response) => response.json())
        .then((data) => {

          const availableMonths = data.available_months || [] // DBì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš© ê°€ëŠ¥í•œ ì›” ë¦¬ìŠ¤íŠ¸ 1015

          //1015 s
          if (availableMonths.length === 0) {

            const currentYear = new Date().getFullYear().toString();
            availableYears[currentYear] = true;

            const option = document.createElement('option');
            option.value = currentYear;
            option.textContent = currentYear;
            yearPicker.appendChild(option);

          } else {

            availableMonths.forEach((month) => {
              const [year] = month.split('-') // ë…„ë„ ì¶”ì¶œ
              availableYears[year] = true // í•´ë‹¹ ë…„ë„ë¥¼ ì €ì¥
            })

            // ì‚¬ìš© ê°€ëŠ¥í•œ ë…„ë„ ì˜µì…˜ ì¶”ê°€
            Object.keys(availableYears).forEach((year) => {
              const option = document.createElement('option')
              option.value = year
              option.textContent = year
              yearPicker.appendChild(option)
            })


          }

          // ì›” ì˜µì…˜ì„ ë¯¸ë¦¬ ì„¤ì •
          populateMonthPicker()

          // LocalStorageì—ì„œ ì €ì¥ëœ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
          const savedYear = localStorage.getItem('selectedYear')
          const savedMonth = localStorage.getItem('selectedMonth')

          if (savedYear && savedMonth) {
            // ì €ì¥ëœ ë…„/ì›”ì´ ìˆìœ¼ë©´ ì´ë¥¼ ì‚¬ìš©
            yearPicker.value = savedYear
            monthPicker.value = savedMonth
            diaries_monthlysummary(id, savedYear, savedMonth)
          } else {
            // ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ ìµœì‹  ë…„ë„ì™€ ì›”ë¡œ ì„¤ì •
            const latestYear = Object.keys(availableYears).sort().pop() // ê°€ì¥ ìµœì‹  ë…„ë„
            yearPicker.value = latestYear

            // ìµœì‹  ì›” ì„¤ì •
            const currentDate = new Date()
            const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0')
            monthPicker.value = currentMonth

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            diaries_monthlysummary(id, latestYear, currentMonth)
          }
        })
        .catch((error) => {
          console.error('ì›”ë³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', error)
        })
      // í”„ë¡œê·¸ë˜ìŠ¤ ë°” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateProgressBar(percent) {
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
          progressBar.style.width = percent + '%';
          progressBar.textContent = percent + '%';
        }
      }

      let loadingInterval;
      // ë¡œë”© ì‹œì‘ í•¨ìˆ˜
      function startLoading() {
        if (loadingInterval) clearInterval(loadingInterval);
        let percent = 0;
        updateProgressBar(0);
        loadingInterval = setInterval(() => {
          percent += 5; // ì¡°ê¸ˆ ë” ì„¸ë°€í•˜ê²Œ ì¦ê°€
          if (percent >= 90) {
            updateProgressBar(90);
            clearInterval(loadingInterval);
          } else {
            updateProgressBar(percent);
          }
        }, 150); // ì†ë„ ê°œì„ 
      }

      // ì†Œë¹„ ìš”ì•½ API í˜¸ì¶œ
      function diaries_monthlysummary(id, year, month) {
        startLoading(); // ë¡œë”© ì‹œì‘
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.style.display = 'block';

        const loadingMessage = document.querySelector('.spending-summary-red');
        if (loadingMessage) {
          loadingMessage.textContent = 'ëª¨ì•„ëª¨ì•„ê°€ ì—´ì‹¬íˆ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤..ğŸ”';
          loadingMessage.style.display = 'block';
        }

        const chart = document.querySelector('.spending-chart');
        if (chart) chart.style.display = 'none';

        const maxBox = document.querySelector('.max-expenditure-container');
        if (maxBox) maxBox.style.display = 'none';

        const summary = document.querySelector('.spending-summary');
        if (summary) summary.style.display = 'none';

        const view = document.querySelector('.summaryview');
        if (view) view.style.display = 'none';

        const eval = document.querySelector('.evaluation');
        if (eval) eval.style.display = 'none';

        fetch(`/api/v1/diary/monthly/${id}/`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year: year, month: month })
        })
          .then((response) => response.json())
          .then((data) => {
            // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ í›„ ë¡œë”© ìˆ¨ê¸°ê¸°
            if (loadingInterval) clearInterval(loadingInterval);
            updateProgressBar(100);

            setTimeout(() => {
              const loadingContainer = document.getElementById('loading-container');
              if (loadingContainer) loadingContainer.style.display = 'none';
            }, 600);

            if (data.message) {
              const redMsg = document.querySelector('.spending-summary-red');
              if (redMsg) {
                redMsg.textContent = data.message;
                redMsg.style.display = 'block';
              }
            } else if (data.summary || data.content) {
              let parsedData = data.summary || JSON.parse(data.content.replace(/'/g, '"')).summary;

              if (Object.keys(parsedData.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ).length === 0) {
                // ì§€ì¶œ ë‚´ì—­ì´ ì—†ëŠ” ê²½ìš°
                if (redMsg) {
                  redMsg.textContent = 'ì´ë²ˆ ë‹¬ì€ ì§€ì¶œ ë‚´ì—­ì´ ì—†ì–´ìš”! ğŸ’¸\nìë…€ì˜ ìš©ëˆê¸°ì…ì¥ì´ ì‘ì„±ë˜ë©´ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.';
                  redMsg.style.display = 'block';
                }
                const sectionsToHide = ['.spending-summary', '.spending-chart', '.max-expenditure-container', '.evaluation', '.summaryview'];
                sectionsToHide.forEach(sel => {
                  const el = document.querySelector(sel);
                  if (el) el.style.display = 'none';
                });
                return;
              }

              if (redMsg) redMsg.style.display = 'none';

              const summaryBox = document.querySelector('.spending-summary');
              if (summaryBox) summaryBox.style.display = 'block';

              const chartBox = document.querySelector('.spending-chart');
              if (chartBox) chartBox.style.display = 'block';

              const maxBox = document.querySelector('.max-expenditure-container');
              if (maxBox) maxBox.style.display = 'block';

              const evalBox = document.querySelector('.evaluation');
              if (evalBox) evalBox.style.display = 'block';

              const viewTitle = document.querySelector('.summaryview');
              if (viewTitle) viewTitle.style.display = 'block';

              updateProgressBar(100);

              // ìš”ì•½ ë‚´ìš© ì—…ë°ì´íŠ¸
              const inc = document.querySelector('.totalincome');
              if (inc) inc.textContent = parsedData.ì´_ìˆ˜ì….toLocaleString('ko-KR');

              const exp = document.querySelector('.totalexpenses');
              if (exp) exp.textContent = parsedData.ì´_ì§€ì¶œ.toLocaleString('ko-KR');

              const rem = document.querySelector('.remainingamount');
              if (rem) rem.textContent = parsedData.ë‚¨ì€_ê¸ˆì•¡.toLocaleString('ko-KR');

              updateMaxExpenditureBox(parsedData.ê°€ì¥_ë§ì´_ì§€ì¶œí•œ_ì¹´í…Œê³ ë¦¬);

              const evalMsg = document.querySelector('.evaluationmsg');
              if (evalMsg) evalMsg.textContent = parsedData.ì§€ì¶œ_íŒ¨í„´_í‰ê°€;

              const categoryExpenses = parsedData.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ;
              const parsedCategoryExpenses = Object.fromEntries(Object.entries(categoryExpenses).map(([key, value]) => [key, parseFloat(value)]));

              drawPieChart(parsedCategoryExpenses);

              const monthText = document.querySelector('.summarymonth');
              if (monthText) monthText.textContent = month;
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            const redMsg = document.querySelector('.spending-summary-red');
            if (redMsg) redMsg.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (loadingContainer) loadingContainer.style.display = 'none';
          })
      }

      // ë…„/ì›” ë³€ê²½ ì‹œ ì†Œë¹„ ìš”ì•½ì„ ê°±ì‹ í•˜ê³  LocalStorageì— ì €ì¥
      yearPicker.addEventListener('change', function () {
        const selectedYear = yearPicker.value
        const selectedMonth = monthPicker.value

        // ì„ íƒí•œ ë…„/ì›”ì„ LocalStorageì— ì €ì¥
        localStorage.setItem('selectedYear', selectedYear)
        localStorage.setItem('selectedMonth', selectedMonth)

        diaries_monthlysummary(id, selectedYear, selectedMonth)
      })

      monthPicker.addEventListener('change', function () {
        const selectedYear = yearPicker.value
        const selectedMonth = monthPicker.value

        // ì„ íƒí•œ ë…„/ì›”ì„ LocalStorageì— ì €ì¥
        localStorage.setItem('selectedYear', selectedYear)
        localStorage.setItem('selectedMonth', selectedMonth)

        diaries_monthlysummary(id, selectedYear, selectedMonth)
      })

      // ì´ˆê¸° ë°ì´í„° ë¡œë”©
      loadProfileAndEncouragement(id);
    });


    // ì•„ì´ì½˜ í´ë¦­ ì‹œ ì…ë ¥ì°½ í† ê¸€
    const editIcon = document.getElementById('edit-icon');
    if (editIcon) {
      editIcon.addEventListener('click', function () {
        const inputDiv = document.getElementById('encouragement-input');
        if (inputDiv) {
          inputDiv.style.display = inputDiv.style.display === 'none' ? 'block' : 'none';
        }
      });
    }

    // ì‘ì› ë©”ì‹œì§€ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const saveEncouragementBtn = document.getElementById('save-encouragement');
    if (saveEncouragementBtn) {
      saveEncouragementBtn.addEventListener('click', function () {
        const encouragement = document.getElementById('edit-encouragement').value;

        if (encouragement.trim() === '') {
          alert('ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const formData = new FormData();
        formData.append('encouragement', encouragement);

        fetch(`/api/v1/accounts/children/${id}/`, {
          method: 'PUT',
          credentials: 'include',
          body: formData
        })
          .then(response => {
            if (response.ok) {
              alert('ì‘ì› ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
              const msgEl = document.querySelector('.encouragement-message');
              if (msgEl) msgEl.textContent = encouragement; // ì €ì¥ëœ ë©”ì‹œì§€ í‘œì‹œ

              const inputField = document.getElementById('edit-encouragement');
              if (inputField) inputField.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”

              const inputDiv = document.getElementById('encouragement-input');
              if (inputDiv) inputDiv.style.display = 'none'; // ì…ë ¥ì°½ ìˆ¨ê¹€
            } else {
              alert('ì‘ì› ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('ì‘ì› ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
      });
    }

    // í”„ë¡œí•„ ë° ì‘ì› ë©”ì‹œì§€ ë¡œë“œ
    function loadProfileAndEncouragement(id) {
      if (!id) return;
      fetch(`/api/v1/accounts/children/${id}/`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(response => {
          if (!response.ok) {
            if (response.status === 403) {
              window.location.href = '/access-error/';
              return;
            }
            throw new Error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨');
          }
          return response.json();
        })
        .then(data => {
          if (!data || !data.child) return;
          // ê¸°ì¡´ í”„ë¡œí•„ ë°ì´í„° ë¡œë“œ ì²˜ë¦¬
          const profilePictureElement = document.querySelector('.childavatar');
          if (profilePictureElement) {
            profilePictureElement.src = data.child.images || "{{ static('images/default_profile.png') }}";
          }

          const summaryNameEl = document.querySelector('.summaryname');
          if (summaryNameEl) summaryNameEl.textContent = data.child.first_name;

          const childNameEl = document.querySelector('.childname');
          if (childNameEl) childNameEl.textContent = data.child.first_name;

          const childName2El = document.querySelector('.childname2');
          if (childName2El) childName2El.textContent = data.child.first_name;

          // ë‚˜ì´ í‘œì‹œ
          const ageEl = document.querySelector('.age');
          if (ageEl) {
            const birthDate = new Date(data.child.birthday);
            const age = new Date().getFullYear() - birthDate.getFullYear();
            ageEl.textContent = age;
          }

          // í˜„ì¬ ì”ì•¡ í‘œì‹œ (total)
          const currentAmountEl = document.querySelector('.current-amount');
          if (currentAmountEl) {
            const totalAmount = data.child.total || 0; // ì´ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°, ê¸°ë³¸ê°’ 0
            currentAmountEl.textContent = totalAmount.toLocaleString('ko-KR') + 'ì›';
          }

          // ì‘ì› ë©”ì‹œì§€ í‘œì‹œ
          const msgEl = document.querySelector('.encouragement-message');
          if (msgEl) msgEl.textContent = data.child.encouragement || 'ë¹„í–‰ê¸° ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ì•„ì´ì—ê²Œ ì¡°ì–¸ ë˜ëŠ” ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.';
        })
        .catch(error => console.error('Error:', error));
    }

    // íŒŒì´ ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function drawPieChart(data) {
      const chartContainer = document.getElementById('pie-chart')
      chartContainer.innerHTML = '' // ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•´ ì´ˆê¸°í™”

      const width = 60
      const height = 60
      const margin = 20
      const radius = Math.min(width, height) / 2 - margin
      const innerRadius = 30
      d3.select('#pie-chart svg').remove()

      const svg = d3
        .select('#pie-chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', `0 0 ${width} ${height}`)
        .style('max-width', '90%')
        .append('g')
        .attr('transform', `translate(${width / 2}, ${height / 2})`)

      // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ ì„¤ì •
      const color = d3.scaleOrdinal().domain(['ìŒì‹', 'ìŒë£Œ/ê°„ì‹', 'ë¬¸êµ¬/ì™„êµ¬', 'êµí†µ', 'ë¬¸í™”/ì—¬ê°€', 'ì„ ë¬¼', 'ì €ì¶•', 'ê¸°íƒ€']).range(['#FF9999', '#FFB76F', '#FDEA3B', '#7BEF7B', '#99CCFF', '#FF99CC', '#21FFFF', '#CC99FF'])

      const pie = d3.pie().value((d) => d[1])

      const data_ready = pie(Object.entries(data))
      const total = Object.values(data).reduce((acc, val) => acc + val, 0)

      // ì¹´í…Œê³ ë¦¬ì™€ ìƒ‰ìƒì„ ë§¤í•‘í•˜ëŠ” ê°ì²´
      const categoryColors = {
        'ìŒì‹': 'darkpink',
        'ìŒë£Œ/ê°„ì‹': 'apricot',
        'ë¬¸êµ¬/ì™„êµ¬': 'yellow',
        'êµí†µ': 'green',
        'ë¬¸í™”/ì—¬ê°€': 'sky',
        'ì„ ë¬¼': 'pink',
        'ì €ì¶•': 'teal',
        'ê¸°íƒ€': 'lavender'
      };

      // ì¹´í…Œê³ ë¦¬ë¥¼ í¼ì„¼íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      const sortedCategories = Object.entries(data)
        .map(([category, amount]) => {
          return {
            category,
            amount,
            percentage: (amount / total) * 100
          };
        })
        .filter(item => item.percentage >= 0.1) // 0.1% ë¶€í„° í‘œì‹œ
        .sort((a, b) => b.percentage - a.percentage); // í¼ì„¼íŠ¸ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬

      // ê·¸ë˜í”„ì— í‘œì‹œëœ ì¹´í…Œê³ ë¦¬ë§Œ ëª©ë¡ìœ¼ë¡œ í‘œì‹œ
      const transparentBox = document.querySelector('.transparent-box p');
      transparentBox.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™”

      sortedCategories.forEach(item => {
        const colorClass = categoryColors[item.category] || 'default-color';
        transparentBox.innerHTML += `<span class="${colorClass}">â¦</span>${item.category} `;
      });

      // ë„ë„›í˜• íŒŒì´ ì¡°ê° ê·¸ë¦¬ê¸°
      svg
        .selectAll('path')
        .data(data_ready)
        .join('path')
        .attr(
          'd',
          d3
            .arc()
            .innerRadius(innerRadius) // ë„ë„› ì¤‘ì•™ ë°˜ì§€ë¦„
            .outerRadius(radius) // ì™¸ê³½ ë°˜ì§€ë¦„ ì„¤ì •
        )
        .attr('fill', (d) => {
          // ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬ (ê¸°ë³¸ ìƒ‰ìƒ ì§€ì •)
          if (!color.domain().includes(d.data[0])) {
            return '#CC99FF'
          }
          return color(d.data[0])
        })
        .attr('stroke', 'white')
        .style('stroke-width', '2px')
        .style('opacity', 0.7)

      svg
        .selectAll('text')
        .data(data_ready)
        .join('text')
        .text((d) => {
          const percentage = (d.data[1] / total) * 100;
          if (percentage >= 5) {
            return `${((d.data[1] / total) * 100).toFixed(1)}%`; // 5ë²ˆì§¸ê¹Œì§€ë©´ì„œ 5% ì´ìƒì¸ ê²½ìš°ë§Œ í¼ì„¼íŠ¸ í‘œì‹œ
          }
          return ''; // 5% ë¯¸ë§Œì´ê±°ë‚˜ 6ë²ˆì§¸ë¶€í„°ëŠ” í‘œì‹œ ì•ˆ í•¨
        })
        .attr('transform', (d) => {
          const pos = d3
            .arc()
            .innerRadius(innerRadius)
            .outerRadius(radius * 1.3) // í…ìŠ¤íŠ¸ ì™¸ê³½ìœ¼ë¡œ ë°°ì¹˜
            .centroid(d)
          return `translate(${pos[0]}, ${pos[1]})`
        })
        .style('text-anchor', 'middle')
        .style('font-size', '4px')
    }
  </script>
  {% endblock %}