{% extends 'base.html' %}

{% block title %}ëª¨ì•„ëª¨ì•„ :: ì›”ë§ê²°ì‚°{% endblock %}

{% block extra_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="{{ static('css/profile.css') }}">
<link rel="stylesheet" href="{{ static('css/profile_detail.css') }}?var=0.0.3">
<style>
    .container {
        height: 100vh;
        overflow-y: auto;
        padding-bottom: 20px;
    }

    /* ì›”ë§ê²°ì‚° í…Œë§ˆ ìƒ‰ìƒ: ë…¸ë‘ */
    .report-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .report-header h3 {
        margin: 0;
        font-weight: 700;
        color: #FFCD00;
    }

    .report-header .report-icon {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    /* ë…„/ì›” ì„ íƒê¸° ìŠ¤íƒ€ì¼ */
    .picker-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .picker-container select {
        padding: 10px 20px;
        border: 2px solid #FFCD00;
        border-radius: 10px;
        background-color: #FFFEF0;
        font-size: 16px;
        color: #333;
        cursor: pointer;
    }

    .picker-container select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 205, 0, 0.3);
    }

    /* í”„ë¡œí•„ ì¹´ë“œ */
    .profile-card {
        background: linear-gradient(135deg, #FFCD00 0%, #FFB347 100%);
        color: white;
        border-radius: 15px;
        padding: 15px 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .profile-card h5 {
        margin: 0;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .summary-cards {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-bottom: 20px;
    }

    .summary-card {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(255, 205, 0, 0.15);
    }

    .summary-card.income {
        border-top: 4px solid #27AE60;
    }

    .summary-card.expense {
        border-top: 4px solid #E74C3C;
    }

    .summary-card.balance {
        border-top: 4px solid #FFCD00;
    }

    .summary-card h6 {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
    }

    .summary-card .amount {
        font-size: 18px;
        font-weight: 700;
    }

    .summary-card.income .amount {
        color: #27AE60;
    }

    .summary-card.expense .amount {
        color: #E74C3C;
    }

    .summary-card.balance .amount {
        color: #FFCD00;
    }

    /* ì°¨íŠ¸ ë° ìµœëŒ€ ì†Œë¹„ ì„¹ì…˜ */
    .chart-max-section {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .chart-container {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(255, 205, 0, 0.15);
    }

    .chart-container h5 {
        color: #FFCD00;
        margin-bottom: 15px;
        font-weight: 600;
        font-size: 14px;
    }

    #pie-chart {
        display: flex;
        justify-content: center;
    }

    .max-category-container {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(255, 205, 0, 0.15);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .max-category-container h5 {
        color: #FFCD00;
        margin-bottom: 15px;
        font-weight: 600;
        font-size: 14px;
    }

    .max-category-box {
        background: linear-gradient(135deg, #FFF8DC 0%, #FFFEF0 100%);
        border: 2px solid #FFCD00;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        width: 100%;
    }

    .max-category-name {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .max-category-amount {
        font-size: 14px;
        color: #666;
    }

    /* ì¹´í…Œê³ ë¦¬ ë²”ë¡€ */
    .category-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
    }

    .legend-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    /* AI í‰ê°€ ìŠ¤íƒ€ì¼ */
    .ai-evaluation {
        background: linear-gradient(135deg, #FFFEF0 0%, #FFF8DC 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #FFCD00;
    }

    .ai-evaluation h5 {
        color: #FFCD00;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }

    .ai-evaluation p {
        color: #333;
        line-height: 1.8;
        margin: 0;
        white-space: pre-line;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-container {
        text-align: center;
        padding: 20px;
    }

    .loading-message {
        color: #FFCD00;
        font-size: 16px;
        margin-bottom: 15px;
    }

    .progress {
        height: 20px;
        border-radius: 10px;
        background-color: #FFFEF0;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(135deg, #FFCD00 0%, #FFB347 100%);
        transition: width 0.3s ease;
    }

    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #999;
        background: #f9f9f9;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
        .chart-max-section {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
    <div class="report-header">
        <div class="report-icon">ğŸ“†</div>
        <h3>ì›”ë§ê²°ì‚° ë¦¬í¬íŠ¸</h3>
    </div>

    <!-- ë…„/ì›” ì„ íƒê¸° -->
    <div class="picker-container">
        <select id="year-picker"></select>
        <select id="month-picker"></select>
    </div>



    <!-- ë¡œë”© ì»¨í…Œì´ë„ˆ -->
    <div id="loading-container" class="loading-container" style="display: none;">
        <div class="loading-message">ëª¨ì•„ëª¨ì•„ê°€ ì—´ì‹¬íˆ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...ğŸ”</div>
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ -->
    <div id="no-data-message" class="no-data-message" style="display: none;">
        <p>ğŸ“† ì´ë²ˆ ë‹¬ ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p>ìš©ëˆê¸°ì…ì¥ì—ì„œ ì‚¬ìš© ë‚´ì—­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!</p>
    </div>

    <!-- ì›”ê°„ ìš”ì•½ ì¹´ë“œ -->
    <div id="summary-section" class="summary-cards" style="display: none;">
        <div class="summary-card income">
            <h6>ì´ ìˆ˜ì…</h6>
            <div class="amount" id="total-income">0ì›</div>
        </div>
        <div class="summary-card expense">
            <h6>ì´ ì§€ì¶œ</h6>
            <div class="amount" id="total-expense">0ì›</div>
        </div>
        <div class="summary-card balance">
            <h6>ë‚¨ì€ ê¸ˆì•¡</h6>
            <div class="amount" id="monthly-balance">0ì›</div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ë° ìµœëŒ€ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ -->
    <div id="chart-max-section" class="chart-max-section" style="display: none;">
        <div class="chart-container">
            <h5>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h5>
            <div id="pie-chart"></div>
            <div id="category-legend" class="category-legend"></div>
        </div>
        <div class="max-category-container">
            <h5>ğŸ† ì´ë²ˆ ë‹¬ ìµœëŒ€ ì†Œë¹„</h5>
            <div class="max-category-box">
                <div class="max-category-name" id="max-category-name">-</div>
                <div class="max-category-amount" id="max-category-amount">0ì›</div>
            </div>
        </div>
    </div>

    <!-- AI ì§€ì¶œ íŒ¨í„´ í‰ê°€ -->
    <div id="ai-evaluation-section" class="ai-evaluation" style="display: none;">
        <h5>âœï¸ ëª¨ì•„ëª¨ì•„ì˜ í•œë§ˆë””</h5>
        <p id="ai-evaluation-text"></p>
    </div>
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const childId = "{{ child_id }}";
        const chatId = {% if chat_id is not none %}{{ chat_id }}{% else %}null{% endif %};
    const yearPicker = document.getElementById('year-picker');
    const monthPicker = document.getElementById('month-picker');

    // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ
    const categoryColors = {
        'ìŒì‹': '#FF9999',
        'ìŒë£Œ/ê°„ì‹': '#FFB76F',
        'ë¬¸êµ¬/ì™„êµ¬': '#FDEA3B',
        'êµí†µ': '#7BEF7B',
        'ë¬¸í™”/ì—¬ê°€': '#99CCFF',
        'ì„ ë¬¼': '#FF99CC',
        'ì €ì¶•': '#21FFFF',
        'ê¸°íƒ€/ì§€ì¶œ': '#CC99FF',
        'ê¸°íƒ€': '#CC99FF'
    };

    let loadingInterval;



    // ì›” ì„ íƒê¸° ì´ˆê¸°í™” (1-12ì›”)
    function initMonthPicker() {
        monthPicker.innerHTML = '';
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i.toString().padStart(2, '0');
            option.textContent = i + 'ì›”';
            monthPicker.appendChild(option);
        }
    }

    // ì‚¬ìš© ê°€ëŠ¥í•œ ë…„ë„ ë° ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    fetch(`/api/v1/diary/${childId}/available-months/`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
    })
        .then(res => res.json())
        .then(data => {
            const availableMonths = data.available_months || [];
            const availableYears = {};

            if (availableMonths.length === 0) {
                const currentYear = new Date().getFullYear().toString();
                availableYears[currentYear] = true;
            } else {
                availableMonths.forEach(m => {
                    const [year] = m.split('-');
                    availableYears[year] = true;
                });
            }

            // ë…„ë„ ì˜µì…˜ ì¶”ê°€
            yearPicker.innerHTML = '';
            Object.keys(availableYears).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                yearPicker.appendChild(option);
            });

            initMonthPicker();

            // ì €ì¥ëœ ê°’ ë˜ëŠ” í˜„ì¬ ë‚ ì§œë¡œ ì„¤ì •
            const savedYear = localStorage.getItem('selectedYear');
            const savedMonth = localStorage.getItem('selectedMonth');
            const currentDate = new Date();

            if (savedYear && savedMonth) {
                yearPicker.value = savedYear;
                monthPicker.value = savedMonth;
            } else {
                yearPicker.value = Object.keys(availableYears).sort().pop();
                monthPicker.value = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            }

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadMonthlySummary(childId, yearPicker.value, monthPicker.value);
        });

    // ë…„/ì›” ë³€ê²½ ì´ë²¤íŠ¸
    yearPicker.addEventListener('change', onPickerChange);
    monthPicker.addEventListener('change', onPickerChange);

    function onPickerChange() {
        localStorage.setItem('selectedYear', yearPicker.value);
        localStorage.setItem('selectedMonth', monthPicker.value);
        loadMonthlySummary(childId, yearPicker.value, monthPicker.value);
    }


    function updateProgressBar(percent) {
        const bar = document.getElementById('progress-bar');
        bar.style.width = percent + '%';
        bar.textContent = percent + '%';
    }

    function startLoading() {
        if (loadingInterval) clearInterval(loadingInterval);
        let percent = 0;
        updateProgressBar(0);
        loadingInterval = setInterval(() => {
            percent += 5;
            if (percent >= 90) {
                clearInterval(loadingInterval);
            } else {
                updateProgressBar(percent);
            }
        }, 200);
    }

    function loadMonthlySummary(childId, year, month) {
        const loadingEl = document.getElementById('loading-container');
        const noDataEl = document.getElementById('no-data-message');
        const summaryEl = document.getElementById('summary-section');
        const chartMaxEl = document.getElementById('chart-max-section');
        const aiEl = document.getElementById('ai-evaluation-section');

        // ì´ˆê¸°í™”
        loadingEl.style.display = 'block';
        noDataEl.style.display = 'none';
        summaryEl.style.display = 'none';
        chartMaxEl.style.display = 'none';
        aiEl.style.display = 'none';
        startLoading();

        // ë¨¼ì € ì›”ë³„ ê¸°ì…ì¥ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ ê¸°ë³¸ ë°ì´í„°ë¥¼ ë¨¼ì € í‘œì‹œ
        const [year_str, month_str] = [year, month.toString().padStart(2, '0')];
        let url = `/api/v1/diary/${childId}/${year_str}/${month_str}/`;
        if (chatId) {
            url += `?chat_id=${chatId}`;
        }

        console.log('Fetching diary data from:', url);

        fetch(url, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => {
                console.log('Diary API Response Status:', res.status);
                return res.json();
            })
            .then(diaryData => {
                console.log('Monthly Diary Data:', diaryData);
                console.log('Diary count:', (diaryData.diary || []).length);

                let totalIncome = 0;
                let totalExpense = 0;
                const categoryExpenses = {};

                (diaryData.diary || []).forEach(entry => {
                    const amount = parseFloat(entry.amount) || 0;
                    if (entry.transaction_type === 'ìˆ˜ì…') {
                        totalIncome += amount;
                    } else {
                        totalExpense += amount;
                        const cat = entry.category || 'ê¸°íƒ€/ì§€ì¶œ';
                        categoryExpenses[cat] = (categoryExpenses[cat] || 0) + amount;
                    }
                });

                console.log('Calculated - Income:', totalIncome, 'Expense:', totalExpense, 'Categories:', categoryExpenses);

                if (!diaryData.diary || diaryData.diary.length === 0) {
                    loadingEl.style.display = 'none';
                    noDataEl.style.display = 'block';
                    return;
                }

                // ìš”ì•½ í‘œì‹œ
                document.getElementById('total-income').textContent =
                    totalIncome.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('total-expense').textContent =
                    totalExpense.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('monthly-balance').textContent =
                    (totalIncome - totalExpense).toLocaleString('ko-KR') + 'ì›';
                summaryEl.style.display = 'flex';

                // ìµœëŒ€ ì†Œë¹„ ì¹´í…Œê³ ë¦¬
                const maxCategory = Object.entries(categoryExpenses).length > 0
                    ? Object.entries(categoryExpenses).sort((a, b) => b[1] - a[1])[0][0]
                    : '-';
                const maxAmount = categoryExpenses[maxCategory] || 0;

                document.getElementById('max-category-name').textContent = maxCategory;
                document.getElementById('max-category-name').style.color = categoryColors[maxCategory] || '#FFCD00';
                document.getElementById('max-category-amount').textContent =
                    parseFloat(maxAmount).toLocaleString('ko-KR') + 'ì›';

                // íŒŒì´ ì°¨íŠ¸
                const parsedExpenses = {};
                Object.entries(categoryExpenses).forEach(([k, v]) => {
                    parsedExpenses[k] = parseFloat(v);
                });
                if (Object.keys(parsedExpenses).length > 0) {
                    drawPieChart(parsedExpenses, categoryColors);
                    chartMaxEl.style.display = 'flex';
                }

                // ì´ì œ OpenAI í‰ê°€ë¥¼ ìœ„í•´ ì›”ë§ê²°ì‚° API í˜¸ì¶œ (ì„ íƒì‚¬í•­)
                const requestBody = { year: parseInt(year), month: parseInt(month) };
                if (chatId) {
                    requestBody.chat_id = parseInt(chatId);
                }

                console.log('Fetching AI evaluation from:', `/api/v1/diary/monthly/${childId}/`);

                return fetch(`/api/v1/diary/monthly/${childId}/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                })
                    .then(res => {
                        console.log('AI API Response Status:', res.status);
                        return res.json();
                    })
                    .then(data => {
                        console.log('AI API Data:', data);

                        let aiText = '';
                        if (data.summary && data.summary.ì§€ì¶œ_íŒ¨í„´_í‰ê°€) {
                            aiText = data.summary.ì§€ì¶œ_íŒ¨í„´_í‰ê°€;
                        } else if (data.message) {
                            aiText = data.message;
                        } else {
                            aiText = `ì´ë²ˆ ë‹¬ ì´ ${totalIncome}ì›ì˜ ìˆ˜ì…ì´ ìˆì—ˆê³ , ${totalExpense}ì›ì„ ì§€ì¶œí–ˆìŠµë‹ˆë‹¤.`;
                        }

                        document.getElementById('ai-evaluation-text').textContent = aiText;
                        aiEl.style.display = 'block';
                    })
                    .catch(err => {
                        console.error('AI í‰ê°€ ë¡œë“œ ì˜¤ë¥˜:', err);
                        // AI í‰ê°€ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê¸°ë³¸ ë°ì´í„°ëŠ” í‘œì‹œ
                        const basicAI = `ì´ë²ˆ ë‹¬ ì´ ${totalIncome}ì›ì˜ ìˆ˜ì…ì´ ìˆì—ˆê³ , ${totalExpense}ì›ì„ ì§€ì¶œí–ˆìŠµë‹ˆë‹¤.`;
                        document.getElementById('ai-evaluation-text').textContent = basicAI;
                        aiEl.style.display = 'block';
                    });
            })
            .catch(err => {
                if (loadingInterval) clearInterval(loadingInterval);
                loadingEl.style.display = 'none';
                noDataEl.style.display = 'block';
                console.error('ì›”ë³„ ê¸°ì…ì¥ ì¡°íšŒ ì˜¤ë¥˜:', err);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', err.message, err.stack);
            })
            .finally(() => {
                if (loadingInterval) clearInterval(loadingInterval);
                updateProgressBar(100);
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                }, 500);
            });
    }

    function drawPieChart(data, colors) {
        const chartContainer = document.getElementById('pie-chart');
        const legendContainer = document.getElementById('category-legend');
        chartContainer.innerHTML = '';
        legendContainer.innerHTML = '';

        const width = 150;
        const height = 150;
        const radius = Math.min(width, height) / 2 - 10;
        const innerRadius = 40;

        const svg = d3.select('#pie-chart')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2}, ${height / 2})`);

        const pie = d3.pie().value(d => d[1]);
        const dataReady = pie(Object.entries(data));
        const total = Object.values(data).reduce((a, b) => a + b, 0);

        svg.selectAll('path')
            .data(dataReady)
            .join('path')
            .attr('d', d3.arc().innerRadius(innerRadius).outerRadius(radius))
            .attr('fill', d => colors[d.data[0]] || '#CC99FF')
            .attr('stroke', 'white')
            .style('stroke-width', '2px')
            .style('opacity', 0.85);

        // ë²”ë¡€ ìƒì„±
        Object.entries(data)
            .sort((a, b) => b[1] - a[1])
            .forEach(([category, amount]) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <span class="legend-color" style="background-color: ${colors[category] || '#CC99FF'}"></span>
                    <span>${category} ${percentage}%</span>
                `;
                legendContainer.appendChild(legendItem);
            });
    }
});
</script>
{% endblock %}