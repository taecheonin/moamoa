{% extends 'base.html' %}

{% block title %}ëª¨ì•„ëª¨ì•„ :: ë˜‘ë˜‘í•œ ìš©ëˆ ê´€ë¦¬ ìŠµê´€{% endblock %}

{% block extra_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="{{ static('css/profile.css') }}">
<link rel="stylesheet" href="{{ static('css/profile_detail.css') }}?var=0.0.2">
<!-- jQueryì™€ jQuery UI ì¶”ê°€ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<style>
    .container {
        height: 100vh;
        overflow-y: auto;
    }

    #report-section {
        display: none;
    }

    #dashboard-section {
        display: block;
    }

    /* ê²°ì‚° íƒ€ì… íƒ­ ìŠ¤íƒ€ì¼ */
    .report-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .report-tab {
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        border: 2px solid #FFCD00;
        background: white;
        color: #333;
    }

    .report-tab:hover {
        background: #FFF8DC;
    }

    .report-tab.active {
        background: linear-gradient(135deg, #FFCD00 0%, #FFB347 100%);
        color: white;
        border-color: #FFCD00;
        box-shadow: 0 4px 15px rgba(255, 205, 0, 0.4);
    }

    .report-tab.daily.active {
        background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
        border-color: #4ECDC4;
        box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
    }

    .report-tab.yearly.active {
        background: linear-gradient(135deg, #A770EF 0%, #CF8BF3 100%);
        border-color: #A770EF;
        box-shadow: 0 4px 15px rgba(167, 112, 239, 0.4);
    }

    /* ì¼ì¼ê²°ì‚° ë‚ ì§œ ì„ íƒê¸° */
    .date-picker-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .date-picker-container input[type="date"] {
        padding: 8px 15px;
        border: 2px solid #FFCD00;
        border-radius: 10px;
        background-color: #FFFEF0;
        font-size: 14px;
    }

    /* ë¦¬í¬íŠ¸ í—¤ë” ìŠ¤íƒ€ì¼ */
    .report-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .report-header h3 {
        margin: 0;
        font-weight: 700;
    }

    .report-header.daily h3 {
        color: #4ECDC4;
    }

    .report-header.monthly h3 {
        color: #FFCD00;
    }

    .report-header.yearly h3 {
        color: #A770EF;
    }

    .report-header .report-icon {
        font-size: 2em;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ (ìë…€ ëª©ë¡) -->
    <div id="dashboard-section">
        <!-- ë¶€ëª¨ë‹˜ í™˜ì˜ ë©”ì‹œì§€ -->
        <div class="greeting">
            <img src="#" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-picture">
            <p>ì•ˆë…•í•˜ì„¸ìš”.<br> ë¶€ëª¨ë‹˜!</p>
        </div>

        <!-- ìë…€ í”„ë¡œí•„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ -->
        <div class="card-container"></div>

        <!-- + í‚¤ì¦ˆ ê³„ì • ì¶”ê°€ -->
        <div class="add-account">+í‚¤ì¦ˆ ê³„ì • ì¶”ê°€</div>

        <div class="text-center mt-5 mb-5">
            <a href="/" class="btn btn-outline-secondary">ëª¨ì•„ëª¨ì•„ í™ˆìœ¼ë¡œ ì´ë™</a>
        </div>

        <!-- ìë…€ ì •ë³´ ìˆ˜ì • í¼ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
        <div class="edit-form-container" style="display: none;">
            <h4>í”„ë¡œí•„ ìˆ˜ì •</h4>
            <input type="text" id="edit-firstname" placeholder="ì´ë¦„"><br>
            <input type="date" id="edit-birthday" placeholder="ìƒì¼" required max="" onkeydown="return false;"><br>
            <input type="password" id="edit-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"><br>
            <form class="file-upload-form">
                <label for="edit-upload" class="custom-file-upload">ì‚¬ì§„ ì„ íƒ</label>
                <input type="file" id="edit-upload" style="display:none;" onchange="showFileName()" />
                <span id="file-name"> </span>
            </form>
            <button id="save-button">ì €ì¥</button>
        </div>
    </div>

    <!-- ë¦¬í¬íŠ¸ ìƒì„¸ ì„¹ì…˜ -->
    <div id="report-section">
        <!-- Greeting -->
        <div class="greeting">
            <h4>ì•ˆë…•í•˜ì„¸ìš”. ë¶€ëª¨ë‹˜!</h4>
        </div>

        <!-- ê²°ì‚° íƒ€ì… íƒ­ -->
        <div class="report-tabs">
            <div class="report-tab daily" data-type="daily" onclick="switchReportType('daily')">
                ğŸ“… ì¼ì¼ê²°ì‚°
            </div>
            <div class="report-tab monthly" data-type="monthly" onclick="switchReportType('monthly')">
                ğŸ“† ì›”ë§ê²°ì‚°
            </div>
            <div class="report-tab yearly" data-type="yearly" onclick="switchReportType('yearly')">
                ğŸ‰ ì—°ë§ê²°ì‚°
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
        <div class="report-header" id="report-header">
            <div class="report-icon" id="report-icon">ğŸ“†</div>
            <h3 id="report-title">ì›”ë§ê²°ì‚° ë¦¬í¬íŠ¸</h3>
        </div>

        <!-- ì¼ì¼ê²°ì‚° ë‚ ì§œ ì„ íƒê¸° -->
        <div class="date-picker-container" id="daily-picker" style="display: none;">
            <input type="date" id="daily-date-picker" onchange="onDailyDateChange()">
        </div>

        <!-- ì›”ë§ê²°ì‚° ë…„ì›” ì„ íƒ ì…ë ¥ í•„ë“œ -->
        <div class="d-flex justify-content-center mb-3" id="monthly-picker">
            <select id="year-picker" class="form-select w-auto"
                style="background-color: rgb(255, 252, 241); border-color: #FFCD00;">ë…„</select>
            <select id="month-picker" class="form-select w-auto ms-2"
                style="background-color: rgb(255, 252, 241); border-color: #FFCD00;">ì›”</select>
        </div>

        <!-- ì—°ë§ê²°ì‚° ë…„ë„ ì„ íƒê¸° -->
        <div class="d-flex justify-content-center mb-3" id="yearly-picker" style="display: none;">
            <select id="yearly-year-picker" class="form-select w-auto"
                style="background-color: #F3E5F5; border-color: #A770EF;">ë…„</select>
        </div>

        <!-- Profile Card -->
        <div class="profile-card">
            <div class="profile-info">
                <h5>í˜„ì¬ ì”ì•¡: <span class="current-amount"></span></h5>
            </div>
        </div>

        <div class="summery-container">
            <!-- Spending Summary -->
            <p class="summaryview">
                <!-- <span class="summarymonth"></span>ì›” <span class="summaryname"></span> ìë…€ì˜ ì†Œë¹„ -->
                <span class="summarymonth"></span>ì›”ìë…€ì˜ ì†Œë¹„
            </p>
            <div class="d-flex justify-content-between align-items-start spending-summary-container">
                <!-- Pie Chart (ì™¼ìª½) -->
                <div class="spending-chart">
                    <div id="pie-chart"></div>
                </div>

                <!-- Maximum Expenditure Box (ì˜¤ë¥¸ìª½) -->
                <div class="max-expenditure-container">
                    <div class="max-expenditure-box">
                        <p>ì´ë²ˆ ë‹¬ ìµœëŒ€ ì†Œë¹„</p>
                        <div class="category-box">
                            <strong class="maximumconsumption"></strong>
                        </div>
                    </div>
                    <!-- íˆ¬ëª… ë°•ìŠ¤ -->
                    <div class="transparent-box">
                        <p>
                            <span class="darkpink">â¦</span>ìŒì‹
                            <span class="apricot">â¦</span>ìŒë£Œ/ê°„ì‹
                            <span class="yellow">â¦</span>ë¬¸êµ¬/ì™„êµ¬<br />
                            <span class="green">â¦</span>êµí†µ
                            <span class="sky">â¦</span>ë¬¸í™”/ì—¬ê°€
                            <span class="pink">â¦</span>ì„ ë¬¼<br />
                            <span class="teal">â¦</span>ì €ì¶•
                            <span class="lavender">â¦</span>ê¸°íƒ€/ì§€ì¶œ
                        </p>
                    </div>
                </div>
            </div>

            <!-- Spending Info (ì•„ë˜ì— ë°°ì¹˜) -->
            <div class="spending-summary">
                <div class="spending-info">
                    <!-- <p>ì´ ìˆ˜ì…: <span class="totalincome">0</span>ì›</p>
                    <p>ì´ ì§€ì¶œ: <span class="totalexpenses">0</span>ì›</p>
                    <p>ë‚¨ì€ ê¸ˆì•¡: <span class="remainingamount">0</span>ì›</p> -->

                    <p>ì´ ìˆ˜ì…: <span class="totalincome">0</span>ì›
                        ì´ ì§€ì¶œ: <span class="totalexpenses">0</span>ì›
                        ë‚¨ì€ ê¸ˆì•¡: <span class="remainingamount">0</span>ì›</p>

                </div>
            </div>

            <!-- ë¡œë”© ë©”ì‹œì§€ì™€ í”„ë¡œê·¸ë˜ìŠ¤ ë°”ë¥¼ ë‹´ì„ ì»¨í…Œì´ë„ˆ -->
            <div class="spending-summary-red"></div>
            <div class="loading-container" style="display: none;">
                <div class="progress" role="progressbar" aria-label="Loading" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">
                    <div class="progress-bar text-bg-warning" id="progress-bar" style="width: 0%">0%</div>
                </div>
            </div>

            <!-- Evaluation -->
            <div class="evaluation">
                <h6>ëª¨ì•„ëª¨ì•„ì˜ í•œë§ˆë””âœï¸</h6>
                <p class="evaluationmsg"></p>
            </div>

            <!-- Suggestions -->
            <!-- <div class="suggestions">
                <h6>ì•„ì´ì—ê²Œ ë³´ë‚´ëŠ” í•œ ë§ˆë””
                    <img src="{{ static('images/message_icon.png') }}" id="edit-icon"
                        style="cursor: pointer; width: 24px; height: 24px; display: inline-block; margin-left: 5px;"
                        alt="Edit Icon">
                </h6>
                <div class="encouragement-message"></div>
                <div id="encouragement-input" style="display: none;">
                    <textarea id="edit-encouragement" placeholder="ì•„ì´ì—ê²Œ ë³´ë‚¼ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                        class="custom-textarea"></textarea><br>
                    <button id="save-encouragement">ë³´ë‚´ê¸°</button>
                </div>
            </div> -->

            <!-- <div class="text-center mt-4">
                <button class="btn btn-outline-warning" onclick="showDashboard()">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div> -->
        </div>
    </div>
</div>

<script type="text/javascript">
    // ì „ì—­ ìƒíƒœ
    let currentChildId = null;
    let currentReportType = 'monthly';

    function getChildIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('child_id');
    }

    function getReportTypeFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('report_type') || 'monthly';
    }

    // ë¦¬í¬íŠ¸ íƒ€ì… ì „í™˜ í•¨ìˆ˜
    function switchReportType(type) {
        currentReportType = type;

        // íƒ­ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.report-tab').forEach(tab => {
            tab.classList.remove('active');
            if (tab.dataset.type === type) {
                tab.classList.add('active');
            }
        });

        // í—¤ë” ì—…ë°ì´íŠ¸
        const header = document.getElementById('report-header');
        const icon = document.getElementById('report-icon');
        const title = document.getElementById('report-title');

        header.className = 'report-header ' + type;

        if (type === 'daily') {
            icon.textContent = 'ğŸ“…';
            title.textContent = 'ì¼ì¼ê²°ì‚° ë¦¬í¬íŠ¸';
        } else if (type === 'monthly') {
            icon.textContent = 'ğŸ“†';
            title.textContent = 'ì›”ë§ê²°ì‚° ë¦¬í¬íŠ¸';
        } else if (type === 'yearly') {
            icon.textContent = 'ğŸ‰';
            title.textContent = 'ì—°ë§ê²°ì‚° ë¦¬í¬íŠ¸';
        }

        // ë‚ ì§œ ì„ íƒê¸° í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('daily-picker').style.display = type === 'daily' ? 'flex' : 'none';
        document.getElementById('monthly-picker').style.display = type === 'monthly' ? 'flex' : 'none';
        document.getElementById('yearly-picker').style.display = type === 'yearly' ? 'flex' : 'none';

        // ë°ì´í„° ë¡œë“œ
        if (currentChildId) {
            if (type === 'daily') {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                const todayStr = today.toISOString().split('T')[0];
                const dailyPicker = document.getElementById('daily-date-picker');
                if (dailyPicker) {
                    dailyPicker.value = yesterdayStr;
                    dailyPicker.max = todayStr;
                }
                loadDailySummary(currentChildId, yesterdayStr);
            } else if (type === 'monthly') {
                const yp = document.getElementById('year-picker');
                const mp = document.getElementById('month-picker');
                if (yp.value && mp.value) {
                    diaries_monthlysummary(currentChildId, yp.value, mp.value);
                }
            } else if (type === 'yearly') {
                const yyp = document.getElementById('yearly-year-picker');
                if (yyp.value) {
                    loadYearlySummary(currentChildId, yyp.value);
                }
            }
        }
    }

    // ì¼ì¼ê²°ì‚° ë‚ ì§œ ë³€ê²½
    function onDailyDateChange() {
        const date = document.getElementById('daily-date-picker').value;
        if (currentChildId && date) {
            loadDailySummary(currentChildId, date);
        }
    }

    // ì¼ì¼ê²°ì‚° ë°ì´í„° ë¡œë“œ
    function loadDailySummary(childId, date) {
        startLoading();
        const loadingContainer = document.querySelector('.loading-container');
        if (loadingContainer) loadingContainer.style.display = 'block';

        const loadingMessage = document.querySelector('.spending-summary-red');
        if (loadingMessage) {
            loadingMessage.textContent = 'ì˜¤ëŠ˜ í•˜ë£¨ ê¸°ë¡ì„ ë¦¬í¬íŠ¸ ì¤‘ì…ë‹ˆë‹¤...ğŸ“…';
            loadingMessage.style.display = 'block';
        }

        ['.spending-chart', '.max-expenditure-container', '.spending-summary', '.summaryview', '.evaluation'].forEach(sel => {
            const el = document.querySelector(sel);
            if (el) el.style.display = 'none';
        });

        fetch(`/api/v1/diary/daily/${childId}/`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date })
        })
            .then(res => res.json())
            .then(data => {
                if (loadingInterval) clearInterval(loadingInterval);
                updateProgressBar(100);
                setTimeout(() => {
                    if (loadingContainer) loadingContainer.style.display = 'none';
                }, 500);

                if (data.message) {
                    if (loadingMessage) {
                        loadingMessage.textContent = `ğŸ“… ${date}\n\n${data.message}`;
                        loadingMessage.style.display = 'block';
                    }
                    return;
                }

                if (data.summary || data.content) {
                    let summary = data.summary;
                    if (!summary && data.content) {
                        try { summary = JSON.parse(data.content).summary; } catch (e) { }
                    }

                    if (!summary) return;

                    if (loadingMessage) loadingMessage.style.display = 'none';
                    ['.spending-summary', '.spending-chart', '.max-expenditure-container', '.evaluation', '.summaryview'].forEach(sel => {
                        const el = document.querySelector(sel);
                        if (el) el.style.display = 'block';
                    });

                    document.querySelector('.totalincome').textContent = summary.ì´_ìˆ˜ì….toLocaleString('ko-KR');
                    document.querySelector('.totalexpenses').textContent = summary.ì´_ì§€ì¶œ.toLocaleString('ko-KR');
                    document.querySelector('.remainingamount').textContent = summary.ë‚¨ì€_ê¸ˆì•¡.toLocaleString('ko-KR');

                    updateMaxExpenditureBox(summary.ê°€ì¥_ë§ì´_ì§€ì¶œí•œ_ì¹´í…Œê³ ë¦¬);

                    document.querySelector('.evaluationmsg').textContent = summary.ì¼ì¼_í‰ê°€ || "í‰ê°€ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                    document.querySelector('.summarymonth').textContent = date.replace(/-/g, '.');

                    if (summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ && Object.keys(summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ).length > 0) {
                        // ë¬¸ìì—´ë¡œ ëœ ê°’ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íŒŒì‹±
                        const parsedCategoryExpenses = Object.fromEntries(
                            Object.entries(summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ).map(([k, v]) => [k, parseFloat(v)])
                        );
                        drawPieChart(parsedCategoryExpenses);
                    } else {
                        document.querySelector('.spending-chart').style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error("ì¼ì¼ ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
                if (loadingMessage) {
                    loadingMessage.textContent = "ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                }
            });
    }

    // ì—°ë§ê²°ì‚° ë°ì´í„° ë¡œë“œ
    function loadYearlySummary(childId, year) {
        startLoading();
        const loadingContainer = document.querySelector('.loading-container');
        if (loadingContainer) loadingContainer.style.display = 'block';

        const loadingMessage = document.querySelector('.spending-summary-red');
        if (loadingMessage) {
            loadingMessage.textContent = `${year}ë…„ í•œ í•´ ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” ì¤‘...ğŸ‰`;
            loadingMessage.style.display = 'block';
        }

        ['.spending-chart', '.max-expenditure-container', '.spending-summary', '.summaryview', '.evaluation'].forEach(sel => {
            const el = document.querySelector(sel);
            if (el) el.style.display = 'none';
        });

        // 1ì›”ë¶€í„° 12ì›”ê¹Œì§€ ë°ì´í„° ìˆ˜ì§‘
        const monthPromises = [];
        for (let m = 1; m <= 12; m++) {
            const monthStr = m.toString().padStart(2, '0');
            monthPromises.push(
                fetch(`/api/v1/diary/${childId}/${year}/${monthStr}/`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                }).then(res => res.json()).catch(() => ({ diary: [] }))
            );
        }

        Promise.all(monthPromises).then(results => {
            if (loadingInterval) clearInterval(loadingInterval);
            updateProgressBar(100);
            setTimeout(() => {
                if (loadingContainer) loadingContainer.style.display = 'none';
            }, 500);

            let totalIncome = 0, totalExpense = 0;
            const categoryExpenses = {};
            let totalEntries = 0;

            results.forEach(data => {
                (data.diary || []).forEach(entry => {
                    totalEntries++;
                    const amount = parseFloat(entry.amount) || 0;
                    if (entry.transaction_type === 'ìˆ˜ì…') {
                        totalIncome += amount;
                    } else {
                        totalExpense += amount;
                        const cat = entry.category || 'ê¸°íƒ€';
                        categoryExpenses[cat] = (categoryExpenses[cat] || 0) + amount;
                    }
                });
            });

            if (totalEntries === 0) {
                if (loadingMessage) {
                    loadingMessage.textContent = `ğŸ‰ ${year}ë…„\n\nì˜¬í•´ ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.\nìš©ëˆê¸°ì…ì¥ì—ì„œ ì‚¬ìš© ë‚´ì—­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!`;
                    loadingMessage.style.display = 'block';
                }
                return;
            }

            if (loadingMessage) loadingMessage.style.display = 'none';
            ['.spending-summary', '.spending-chart', '.max-expenditure-container', '.evaluation', '.summaryview'].forEach(sel => {
                const el = document.querySelector(sel);
                if (el) el.style.display = 'block';
            });

            document.querySelector('.totalincome').textContent = totalIncome.toLocaleString('ko-KR');
            document.querySelector('.totalexpenses').textContent = totalExpense.toLocaleString('ko-KR');
            document.querySelector('.remainingamount').textContent = (totalIncome - totalExpense).toLocaleString('ko-KR');

            const maxCategory = Object.entries(categoryExpenses).sort((a, b) => b[1] - a[1])[0];
            if (maxCategory) {
                updateMaxExpenditureBox(maxCategory[0]);
            }

            document.querySelector('.evaluationmsg').textContent = `${year}ë…„ í•œ í•´ ë™ì•ˆ ì´ ${totalEntries}ê±´ì˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ì—°ê°„ ${totalExpense.toLocaleString()}ì›ì„ ì‚¬ìš©í–ˆì–´ìš”! ğŸŠ`;
            document.querySelector('.summarymonth').textContent = year + 'ë…„';

            if (Object.keys(categoryExpenses).length > 0) {
                drawPieChart(categoryExpenses);
            }
        });
    }

    function showReport(childId) {
        currentChildId = childId;
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('report-section').style.display = 'block';

        // URLì„ /profile/ ë¡œ ê¹¨ë—í•˜ê²Œ ìœ ì§€ (íŒŒë¼ë¯¸í„° ë…¸ì¶œ ë°©ì§€)
        window.history.replaceState({ child_id: childId }, '', window.location.pathname);

        // ë°ì´í„° ë¡œë“œ
        loadProfileAndEncouragement(childId);

        // ë…„/ì›” ë°ì´í„° ê°€ì ¸ì™€ì„œ ì´ˆê¸° ìš”ì•½ ë…¸ì¶œ
        fetchAvailableMonths(childId);

        // ì—°ë§ê²°ì‚°ìš© ë…„ë„ ì„ íƒê¸° ì´ˆê¸°í™”
        initYearlyPicker(childId);

        // ì´ˆê¸° ë¦¬í¬íŠ¸ íƒ€ì… ì„¤ì •
        const initialReportType = getReportTypeFromUrl();
        switchReportType(initialReportType);
    }

    function initYearlyPicker(childId) {
        const yearlyPicker = document.getElementById('yearly-year-picker');
        if (!yearlyPicker) return;

        yearlyPicker.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= currentYear - 5; y--) {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y + 'ë…„';
            yearlyPicker.appendChild(option);
        }
        yearlyPicker.value = currentYear;

        yearlyPicker.onchange = () => {
            loadYearlySummary(currentChildId, yearlyPicker.value);
        };
    }

    function showDashboard() {
        currentChildId = null;
        document.getElementById('dashboard-section').style.display = 'block';
        document.getElementById('report-section').style.display = 'none';

        // URLì„ /profile/ ë¡œ ìœ ì§€
        window.history.replaceState({}, '', window.location.pathname);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const viewMode = "{{ view_mode }}"; // dashboard or report
        const serverChildId = "{{ child_id }}"; // Jinja2 context

        if (viewMode === 'report' && serverChildId && serverChildId !== 'None') {
            // ë¦¬í¬íŠ¸ ì „ìš© ëª¨ë“œ (ëŒ€ì‹œë³´ë“œ ìˆ¨ê¹€)
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('report-section').style.display = 'block';

            // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
            currentChildId = serverChildId;

            // ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ
            showReport(currentChildId);

            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ë“±ì„ ìƒí™©ì— ë§ê²Œ ì¡°ì •í•˜ë ¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬
            // (ì˜ˆ: ëŒ€ì‹œë³´ë“œë¡œ ê°€ëŠ” ë²„íŠ¼ ìˆ¨ê¸°ê±°ë‚˜ ë³€ê²½)

        } else {
            // ê¸°ì¡´ ëŒ€ì‹œë³´ë“œ ë¡œì§
            const initialChildId = getChildIdFromUrl();
            if (initialChildId) {
                showReport(initialChildId);
                // ì§„ì… í›„ ì¦‰ì‹œ URL íŒŒë¼ë¯¸í„° ì œê±° (ë³´ì•ˆ ë° ë¯¸ê´€ìƒ /profile/ ìœ ì§€)
                window.history.replaceState({}, '', window.location.pathname);
            } else {
                loadDashboard();
            }
        }

        // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ëŒ€ì‘
        window.addEventListener('popstate', function (event) {
            // ë¦¬í¬íŠ¸ ëª¨ë“œì¼ ê²½ìš° ë’¤ë¡œê°€ê¸° ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ë”°ë¦„
            if (viewMode === 'report') return;

            const childId = event.state ? event.state.child_id : null;
            if (childId) {
                showReport(childId);
            } else {
                showDashboard();
            }
        });

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const birthdayEl = document.getElementById('edit-birthday');
        if (birthdayEl) birthdayEl.setAttribute('max', todayStr);

        // ì¼ì¼ê²°ì‚° ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™” (ê¸°ë³¸ê°’: ì–´ì œ)
        const dailyDatePicker = document.getElementById('daily-date-picker');
        if (dailyDatePicker) {
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            dailyDatePicker.value = yesterday.toISOString().split('T')[0];
            dailyDatePicker.max = todayStr;
        }
    });

    // --- ëŒ€ì‹œë³´ë“œ ë¡œì§ ---
    function loadDashboard() {
        fetch('/api/v1/accounts/', {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => {
                if (response.status === 401) {
                    window.location.href = '/login/';
                    return;
                }
                if (!response.ok) {
                    throw new Error('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.parent) return;

                const profilePictureElement = document.querySelector('.profile-picture');
                if (profilePictureElement && data.parent.images) {
                    profilePictureElement.src = data.parent.images;
                }

                const container = document.querySelector('.card-container');
                if (!container) return;
                container.innerHTML = '';

                // [ì¶”ê°€] ë‚´ ê°€ê³„ë¶€ (ë³¸ì¸) ì¹´ë“œ
                const myCard = document.createElement('div');
                myCard.classList.add('profile-card');
                myCard.style.border = "2px solid #FFCD00";
                myCard.style.backgroundColor = "#FFFEF0";

                // ì´ë¯¸ì§€ ê²½ë¡œ ì²˜ë¦¬ (ê°„ë‹¨íˆ /media/ ë¶™ì„, ë‹¨ httpë¡œ ì‹œì‘í•˜ë©´ ê·¸ëŒ€ë¡œ)
                let myImg = "{{ static('images/default_profile.png') }}";
                if (data.parent.images) {
                    if (data.parent.images.startsWith('http')) myImg = data.parent.images;
                    else myImg = '/media/' + data.parent.images;
                }

                myCard.innerHTML = `
                    <div class="profile-image">
                        <img src="${myImg}" alt="ë‚´ í”„ë¡œí•„">
                    </div>
                    <div class="profile-info" style="cursor: pointer;" onclick="showReport(${data.parent.id})">
                        <h5>ë‚´ ê°€ê³„ë¶€</h5>
                        <p>${data.parent.first_name} ë‹˜</p>
                    </div>
                    <div class="profile-edit">
                         <button class="edit-button" style="background-color:#FFCD00; color:#333; font-weight:bold;" onclick="event.stopPropagation(); window.location.href='/child_profile/'">ì‘ì„±í•˜ê¸°</button>
                    </div>
                `;
                container.appendChild(myCard);

                data.children.forEach((child, index) => {
                    const profileCard = document.createElement('div');
                    profileCard.classList.add('profile-card');
                    const childImage = child.images || "{{ static('default_profile.png') }}";
                    const remainingAmount = child.total || 0;

                    profileCard.innerHTML = `
                    <div class="profile-image">
                        <img src="${childImage}" class="Child ${index + 1}" alt="Child ${index + 1}">
                        <button class="edit-button" data-child-id="${child.id}">í”„ë¡œí•„ ìˆ˜ì •</button>
                    </div>
                    <div class="profile-info" style="cursor: pointer;" onclick="showReport(${child.id})">
                        <h5>${child.first_name} (ID: ${child.username})</h5>
                        <p>ìƒì¼: ${child.birthday}</p>
                        <p>í˜„ì¬ ì”ì•¡: ${remainingAmount.toLocaleString()}ì›</p>
                    </div>
                    <div class="profile-edit">
                        <div class="delete-button" data-child-id="${child.id}">ì‚­ì œ</div>
                    </div>
                `;
                    container.appendChild(profileCard);
                });

                // ì´ë²¤íŠ¸ ë°”ì¸ë”©
                document.querySelectorAll('.edit-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editChildProfile(button.getAttribute('data-child-id'));
                    });
                });
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const childId = button.getAttribute('data-child-id');
                        if (confirm('ì •ë§ë¡œ ì´ ìë…€ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            deleteChild(childId);
                        }
                    });
                });
            });
    }

    // --- ë¦¬í¬íŠ¸ ë¡œì§ ---
    const categoryColors = {
        'ìŒì‹': '#FF9999', 'ìŒë£Œ/ê°„ì‹': '#FFB76F', 'ë¬¸êµ¬/ì™„êµ¬': '#FDEA3B', 'êµí†µ': '#7BEF7B',
        'ë¬¸í™”/ì—¬ê°€': '#99CCFF', 'ì„ ë¬¼': '#FF99CC', 'ì €ì¶•': '#21FFFF', 'ê¸°íƒ€': '#CC99FF'
    };

    function updateMaxExpenditureBox(category) {
        const categoryElement = document.querySelector('.maximumconsumption');
        if (!categoryElement) return;
        const color = categoryColors[category] || '#000';
        categoryElement.textContent = category;
        categoryElement.style.color = color;
    }

    function populateMonthPicker() {
        const monthPicker = document.getElementById('month-picker');
        if (!monthPicker) return;
        monthPicker.innerHTML = '';
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i.toString().padStart(2, '0');
            option.textContent = i + 'ì›”';
            monthPicker.appendChild(option);
        }
    }

    function fetchAvailableMonths(childId) {
        const yearPicker = document.getElementById('year-picker');
        const monthPicker = document.getElementById('month-picker');
        if (!yearPicker || !monthPicker) return;

        fetch(`/api/v1/diary/${childId}/available-months/`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                const availableMonths = data.available_months || [];
                let availableYears = {};
                yearPicker.innerHTML = '';

                if (availableMonths.length === 0) {
                    const currentYear = new Date().getFullYear().toString();
                    availableYears[currentYear] = true;
                    const option = document.createElement('option');
                    option.value = currentYear; option.textContent = currentYear;
                    yearPicker.appendChild(option);
                } else {
                    availableMonths.forEach(m => {
                        const [year] = m.split('-');
                        availableYears[year] = true;
                    });
                    Object.keys(availableYears).forEach(y => {
                        const option = document.createElement('option');
                        option.value = y; option.textContent = y;
                        yearPicker.appendChild(option);
                    });
                }

                populateMonthPicker();

                const savedYear = localStorage.getItem('selectedYear');
                const savedMonth = localStorage.getItem('selectedMonth');

                if (savedYear && savedMonth) {
                    yearPicker.value = savedYear;
                    monthPicker.value = savedMonth;
                    diaries_monthlysummary(childId, savedYear, savedMonth);
                } else {
                    const latestYear = Object.keys(availableYears).sort().pop();
                    yearPicker.value = latestYear;
                    const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
                    monthPicker.value = currentMonth;
                    diaries_monthlysummary(childId, latestYear, currentMonth);
                }
            });
    }

    function updateProgressBar(percent) {
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }
    }

    let loadingInterval;
    function startLoading() {
        if (loadingInterval) clearInterval(loadingInterval);
        let percent = 0;
        updateProgressBar(0);
        loadingInterval = setInterval(() => {
            percent += 10;
            if (percent >= 90) {
                clearInterval(loadingInterval);
            } else {
                updateProgressBar(percent);
            }
        }, 300);
    }

    function diaries_monthlysummary(id, year, month) {
        startLoading();
        const loadingContainer = document.querySelector('.loading-container');
        if (loadingContainer) loadingContainer.style.display = 'block';

        const loadingMessage = document.querySelector('.spending-summary-red');
        if (loadingMessage) {
            loadingMessage.textContent = 'ëª¨ì•„ëª¨ì•„ê°€ ì—´ì‹¬íˆ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤..ğŸ”';
            loadingMessage.style.display = 'block';
        }

        ['.spending-chart', '.max-expenditure-container', '.spending-summary', '.summaryview', '.evaluation'].forEach(sel => {
            const el = document.querySelector(sel);
            if (el) el.style.display = 'none';
        });

        fetch(`/api/v1/diary/monthly/${id}/`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year, month })
        })
            .then(res => res.json())
            .then(data => {
                if (loadingInterval) clearInterval(loadingInterval);
                updateProgressBar(100);
                setTimeout(() => {
                    if (loadingContainer) loadingContainer.style.display = 'none';
                }, 500);
                if (data.message) {
                    if (loadingMessage) loadingMessage.textContent = data.message;
                } else if (data.summary || data.content) {
                    let parsedData = data.summary || JSON.parse(data.content.replace(/'/g, '"')).summary;

                    if (Object.keys(parsedData.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ).length === 0) {
                        // ì§€ì¶œ ë‚´ì—­ì´ ì—†ëŠ” ê²½ìš°
                        if (loadingMessage) {
                            loadingMessage.textContent = 'ì´ë²ˆ ë‹¬ì€ ì§€ì¶œ ë‚´ì—­ì´ ì—†ì–´ìš”! ğŸ’¸\nê°€ê³„ë¶€(ìš©ëˆê¸°ì…ì¥) ê¸°ë¡ì´ ì‘ì„±ë˜ë©´ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.';
                            loadingMessage.style.display = 'block';
                        }
                        ['.spending-summary', '.spending-chart', '.max-expenditure-container', '.evaluation', '.summaryview'].forEach(sel => {
                            const el = document.querySelector(sel);
                            if (el) el.style.display = 'none';
                        });
                        return;
                    }

                    if (loadingMessage) loadingMessage.style.display = 'none';
                    ['.spending-summary', '.spending-chart', '.max-expenditure-container', '.evaluation', '.summaryview'].forEach(sel => {
                        const el = document.querySelector(sel);
                        if (el) el.style.display = 'block';
                    });

                    document.querySelector('.totalincome').textContent = parsedData.ì´_ìˆ˜ì….toLocaleString('ko-KR');
                    document.querySelector('.totalexpenses').textContent = parsedData.ì´_ì§€ì¶œ.toLocaleString('ko-KR');
                    document.querySelector('.remainingamount').textContent = parsedData.ë‚¨ì€_ê¸ˆì•¡.toLocaleString('ko-KR');
                    updateMaxExpenditureBox(parsedData.ê°€ì¥_ë§ì´_ì§€ì¶œí•œ_ì¹´í…Œê³ ë¦¬);
                    document.querySelector('.evaluationmsg').textContent = parsedData.ì§€ì¶œ_íŒ¨í„´_í‰ê°€;

                    const categoryExpenses = parsedData.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ;
                    const parsedCategoryExpenses = Object.fromEntries(Object.entries(categoryExpenses).map(([k, v]) => [k, parseFloat(v)]));
                    drawPieChart(parsedCategoryExpenses);
                    document.querySelector('.summarymonth').textContent = month;
                }
            });
    }

    function loadProfileAndEncouragement(id) {
        fetch(`/api/v1/accounts/children/${id}/`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                if (!data || !data.child) return;
                const summaryNameEl = document.querySelector('.summaryname');
                if (summaryNameEl) summaryNameEl.textContent = data.child.first_name;

                // ë¦¬í¬íŠ¸ ì„¹ì…˜ ë‚´ í˜„ì¬ ì”ì•¡ í‘œì‹œ
                const currentAmountEl = document.querySelector('#report-section .current-amount');
                if (currentAmountEl) {
                    const totalAmount = data.child.total || 0;
                    currentAmountEl.textContent = totalAmount.toLocaleString('ko-KR') + 'ì›';
                }

                const msgEl = document.querySelector('.encouragement-message');
                if (msgEl) msgEl.textContent = data.child.encouragement || 'ì•„ì´ì—ê²Œ ì¡°ì–¸ ë˜ëŠ” ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.';
            })
            .catch(error => console.error('í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error));
    }

    // --- ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° ---
    function drawPieChart(data) {
        const chartContainer = document.getElementById('pie-chart');
        if (!chartContainer) return;
        chartContainer.innerHTML = '';

        const width = 60, height = 60, margin = 20;
        const radius = Math.min(width, height) / 2 - margin;
        const innerRadius = 30;

        const svg = d3.select('#pie-chart').append('svg')
            .attr('width', width).attr('height', height).attr('viewBox', `0 0 ${width} ${height}`)
            .style('max-width', '90%').append('g').attr('transform', `translate(${width / 2}, ${height / 2})`);

        const color = d3.scaleOrdinal().domain(Object.keys(categoryColors)).range(Object.values(categoryColors));
        const pie = d3.pie().value(d => d[1]);
        const data_ready = pie(Object.entries(data));
        const total = Object.values(data).reduce((a, b) => a + b, 0);

        svg.selectAll('path').data(data_ready).join('path')
            .attr('d', d3.arc().innerRadius(innerRadius).outerRadius(radius))
            .attr('fill', d => color(d.data[0])).attr('stroke', 'white').style('stroke-width', '2px').style('opacity', 0.7);
    }

    // ìˆ˜ì •/ì‚­ì œ í•¨ìˆ˜
    function editChildProfile(childId) {
        fetch(`/api/v1/accounts/children/${childId}/`, { method: 'GET', credentials: 'include' })
            .then(res => res.json())
            .then(data => {
                document.getElementById('edit-firstname').value = data.child.first_name;
                document.getElementById('edit-birthday').value = data.child.birthday;
                document.querySelector('.edit-form-container').style.display = 'block';

                document.getElementById('save-button').onclick = () => {
                    const formData = new FormData();
                    formData.append('firstname', document.getElementById('edit-firstname').value);
                    formData.append('birthday', document.getElementById('edit-birthday').value);
                    const pwd = document.getElementById('edit-password').value;
                    if (pwd) formData.append('password', pwd);
                    const file = document.getElementById('edit-upload').files[0];
                    if (file) formData.append('profile_image', file);

                    fetch(`/api/v1/accounts/children/${childId}/`, { method: 'PUT', credentials: 'include', body: formData })
                        .then(res => { if (res.ok) window.location.reload(); });
                };
            });
    }

    function deleteChild(childId) {
        fetch(`/api/v1/accounts/children/${childId}/`, { method: 'DELETE', credentials: 'include' })
            .then(res => { if (res.status === 204) window.location.reload(); });
    }

    function showFileName() {
        const input = document.getElementById('edit-upload');
        document.getElementById('file-name').textContent = input.files[0]?.name || " ";
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ë¦¬í¬íŠ¸ ë‚´ ì•„ì´ ì •ë³´ ìˆ˜ì •)
    const editIcon2 = document.getElementById('edit-icon');
    if (editIcon2) {
        editIcon2.onclick = () => {
            const div = document.getElementById('encouragement-input');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        };
    }
    const saveEncBtn = document.getElementById('save-encouragement');
    if (saveEncBtn) {
        saveEncBtn.onclick = () => {
            const encouragement = document.getElementById('edit-encouragement').value;
            const formData = new FormData();
            formData.append('encouragement', encouragement);
            fetch(`/api/v1/accounts/children/${currentChildId}/`, { method: 'PUT', credentials: 'include', body: formData })
                .then(res => {
                    if (res.ok) {
                        document.querySelector('.encouragement-message').textContent = encouragement;
                        document.getElementById('encouragement-input').style.display = 'none';
                    }
                });
        };
    }

    // ì—°ë„/ì›” ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
    const yp = document.getElementById('year-picker');
    const mp = document.getElementById('month-picker');
    if (yp && mp) {
        [yp, mp].forEach(el => el.onchange = () => {
            localStorage.setItem('selectedYear', yp.value);
            localStorage.setItem('selectedMonth', mp.value);
            diaries_monthlysummary(currentChildId, yp.value, mp.value);
        });
    }
</script>
{% endblock %}