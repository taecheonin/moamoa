{% extends 'base.html' %}

{% block title %}ëª¨ì•„ëª¨ì•„ :: ì¼ì¼ê²°ì‚°{% endblock %}

{% block extra_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<link rel="stylesheet" href="{{ static('css/profile.css') }}">
<link rel="stylesheet" href="{{ static('css/profile_detail.css') }}?var=0.0.3">
<style>
    .container {
        height: 100vh;
        overflow-y: auto;
        padding-bottom: 20px;
    }

    /* ì¼ì¼ê²°ì‚° í…Œë§ˆ ìƒ‰ìƒ: ë¯¼íŠ¸ */
    .report-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .report-header h3 {
        margin: 0;
        font-weight: 700;
        color: #FFCD00;
    }

    .report-header .report-icon {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    /* ë‚ ì§œ ì„ íƒê¸° ìŠ¤íƒ€ì¼ */
    .date-picker-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .date-picker-container input[type="date"] {
        padding: 10px 20px;
        border: 2px solid #FFCD00;
        border-radius: 10px;
        background-color: #FFF8DC;
        font-size: 16px;
        color: #333;
    }

    /* ë‚´ì—­ ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .entry-table-container {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(78, 205, 196, 0.2);
    }

    .entry-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .entry-table th {
        background: linear-gradient(135deg, #FFCD00 0%, #FFB347 100%);
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
    }

    .entry-table th:first-child {
        border-radius: 10px 0 0 0;
    }

    .entry-table th:last-child {
        border-radius: 0 10px 0 0;
    }

    .entry-table td {
        padding: 10px 8px;
        text-align: center;
        border-bottom: 1px solid #FFF8DC;
    }

    .entry-table tr:hover {
        background-color: #F0FFFE;
    }

    .income-amount {
        color: #27AE60;
        font-weight: 600;
    }

    .expense-amount {
        color: #E74C3C;
        font-weight: 600;
    }

    .category-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        background-color: #FFF8DC;
        color: #FFCD00;
    }

    /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .summary-cards {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        margin-bottom: 20px;
    }

    .summary-card {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(78, 205, 196, 0.15);
    }

    .summary-card.income {
        border-top: 4px solid #27AE60;
    }

    .summary-card.expense {
        border-top: 4px solid #E74C3C;
    }

    .summary-card.balance {
        border-top: 4px solid #FFCD00;
    }

    .summary-card h6 {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
    }

    .summary-card .amount {
        font-size: 18px;
        font-weight: 700;
    }

    .summary-card.income .amount {
        color: #27AE60;
    }

    .summary-card.expense .amount {
        color: #E74C3C;
    }

    .summary-card.balance .amount {
        color: #FFCD00;
    }

    /* íŒŒì´ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(78, 205, 196, 0.15);
        max-width: 100%;
    }

    .chart-container h5 {
        color: #FFCD00;
        margin-bottom: 15px;
        font-weight: 600;
    }

    /* ì°¨íŠ¸+ë²”ë¡€ë¥¼ í•œ ì¤„ì— ë°°ì¹˜í•´ í° ì—¬ë°± ì¶•ì†Œ */
    .chart-wrapper {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 24px;
    }

    #pie-chart {
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .category-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 12px 16px;
        margin-top: 0;
        min-width: 140px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    /* AI í•œë§ˆë”” ìŠ¤íƒ€ì¼ */
    .ai-comment {
        background: linear-gradient(135deg, #FFF8DC 0%, #D1F2EB 100%);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #FFCD00;
    }

    .ai-comment h5 {
        color: #FFCD00;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-comment p {
        color: #333;
        line-height: 1.6;
        margin: 0;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading-message {
        text-align: center;
        padding: 40px;
        color: #FFCD00;
        font-size: 16px;
    }

    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #999;
        background: #f9f9f9;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    /* í”„ë¡œí•„ ì¹´ë“œ */
    .profile-card {
        background: linear-gradient(135deg, #FFCD00 0%, #FFB347 100%);
        color: white;
        border-radius: 15px;
        padding: 15px 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .profile-card h5 {
        margin: 0;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- ë¦¬í¬íŠ¸ í—¤ë” -->
    <div class="report-header">
        <div class="report-icon">ğŸ“…</div>
        <h3>ì¼ì¼ê²°ì‚° ë¦¬í¬íŠ¸</h3>
    </div>

    <!-- ë‚ ì§œ ì„ íƒê¸° -->
    <div class="date-picker-container">
        <input type="date" id="daily-date-picker">
    </div>



    <!-- ë¡œë”© ë©”ì‹œì§€ -->
    <div id="loading-message" class="loading-message" style="display: none;">
        ì˜¤ëŠ˜ í•˜ë£¨ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...ğŸ“…
    </div>

    <!-- ë°ì´í„° ì—†ìŒ ë©”ì‹œì§€ -->
    <div id="no-data-message" class="no-data-message" style="display: none;">
        <p>ğŸ“… ì„ íƒí•œ ë‚ ì§œì— ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <p>ìš©ëˆê¸°ì…ì¥ì—ì„œ ì‚¬ìš© ë‚´ì—­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!</p>
    </div>

    <!-- ì¼ì¼ ìš”ì•½ ì¹´ë“œ -->
    <div id="summary-section" class="summary-cards" style="display: none;">
        <div class="summary-card income">
            <h6>ì´ ìˆ˜ì…</h6>
            <div class="amount" id="total-income">0ì›</div>
        </div>
        <div class="summary-card expense">
            <h6>ì´ ì§€ì¶œ</h6>
            <div class="amount" id="total-expense">0ì›</div>
        </div>
        <div class="summary-card balance">
            <h6>ì¼ì¼ ì”ì•¡</h6>
            <div class="amount" id="daily-balance">0ì›</div>
        </div>
    </div>

    <!-- ë‚´ì—­ ëª©ë¡ í…Œì´ë¸” -->
    <div id="entry-table-section" class="entry-table-container" style="display: none;">
        <h5 style="color: #FFCD00; margin-bottom: 15px;">ğŸ“‹ ì˜¤ëŠ˜ì˜ ë‚´ì—­</h5>
        <table class="entry-table">
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ë‚´ìš©</th>
                    <th>ì¹´í…Œê³ ë¦¬</th>
                    <th>ê¸ˆì•¡</th>
                </tr>
            </thead>
            <tbody id="entry-table-body">
            </tbody>
        </table>
    </div>

    <!-- ì¹´í…Œê³ ë¦¬ë³„ íŒŒì´ ì°¨íŠ¸ -->
    <div id="chart-section" class="chart-container" style="display: none;">
        <h5>ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</h5>
        <div class="chart-wrapper">
            <div id="pie-chart"></div>
            <div id="category-legend" class="category-legend"></div>
        </div>
    </div>

    <!-- AI í•œë§ˆë”” -->
    <div id="ai-comment-section" class="ai-comment" style="display: none;">
        <h5>âœï¸ ëª¨ì•„ëª¨ì•„ì˜ í•œë§ˆë””</h5>
        <p id="ai-comment-text"></p>
    </div>
</div>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const childId = "{{ child_id }}";
        const chatId = {% if chat_id is not none %}{{ chat_id }}{% else %}null{% endif %};
    const datePicker = document.getElementById('daily-date-picker');

    // ì¹´í…Œê³ ë¦¬ë³„ ìƒ‰ìƒ
    const categoryColors = {
        'ìŒì‹': '#FF9999',
        'ìŒë£Œ/ê°„ì‹': '#FFB76F',
        'ë¬¸êµ¬/ì™„êµ¬': '#FDEA3B',
        'êµí†µ': '#7BEF7B',
        'ë¬¸í™”/ì—¬ê°€': '#99CCFF',
        'ì„ ë¬¼': '#FF99CC',
        'ì €ì¶•': '#21FFFF',
        'ê¸°íƒ€/ì§€ì¶œ': '#CC99FF',
        'ìš©ëˆ': '#FFCD00',
        'ê¸°íƒ€/ìˆ˜ì…': '#98D8C8'
    };

    // ì–´ì œ ë‚ ì§œë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì´ˆê¸°í™” (ì¼ì¼ê²°ì‚°ì€ ì „ì¼ ê¸°ì¤€ ê²°ê³¼ í‘œì‹œ)
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const todayStr = today.toISOString().split('T')[0];
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    datePicker.value = yesterdayStr;
    datePicker.max = todayStr;

    // ë‚ ì§œ ë³€ê²½ ì´ë²¤íŠ¸
    datePicker.addEventListener('change', function () {
        loadDailySummary(childId, this.value);
    });

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ì–´ì œì ê²°ê³¼)
    loadDailySummary(childId, yesterdayStr);

    function loadDailySummary(childId, date) {
        const loadingEl = document.getElementById('loading-message');
        const noDataEl = document.getElementById('no-data-message');
        const summaryEl = document.getElementById('summary-section');
        const tableEl = document.getElementById('entry-table-section');
        const chartEl = document.getElementById('chart-section');
        const aiEl = document.getElementById('ai-comment-section');

        // ì´ˆê¸°í™”
        loadingEl.style.display = 'block';
        noDataEl.style.display = 'none';
        summaryEl.style.display = 'none';
        tableEl.style.display = 'none';
        chartEl.style.display = 'none';
        aiEl.style.display = 'none';

        // ì„œë²„ API í˜¸ì¶œ
        fetch(`/api/v1/diary/daily/${childId}/`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: date,
                chat_id: chatId || null
            })
        })
            .then(res => res.json())
            .then(data => {
                loadingEl.style.display = 'none';

                if (data.message) {
                    // ë°ì´í„° ì—†ìŒ
                    noDataEl.style.display = 'block';
                    // ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œí•˜ë ¤ë©´: noDataEl.querySelector('p').textContent = data.message;
                    return;
                }

                let summary = data.summary;
                if (!summary && data.content) {
                    try { summary = JSON.parse(data.content).summary; } catch (e) { }
                }

                if (!summary) return;

                // ìš”ì•½ í‘œì‹œ
                document.getElementById('total-income').textContent = summary.ì´_ìˆ˜ì….toLocaleString('ko-KR') + 'ì›';
                document.getElementById('total-expense').textContent = summary.ì´_ì§€ì¶œ.toLocaleString('ko-KR') + 'ì›';
                document.getElementById('daily-balance').textContent = summary.ë‚¨ì€_ê¸ˆì•¡.toLocaleString('ko-KR') + 'ì›';
                summaryEl.style.display = 'flex';

                // í…Œì´ë¸” ë° íŒŒì´ ì°¨íŠ¸ë¥¼ ìœ„í•œ ë°ì´í„°ëŠ” ì—¬ì „íˆ detailì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
                // í•˜ì§€ë§Œ í˜„ì¬ DailySummary APIëŠ” detail listë¥¼ ì£¼ì§€ ì•ŠìŒ. (MonthlySummary ë“±ê³¼ ë‹¬ë¦¬)
                // ë”°ë¼ì„œ detailì„ ìœ„í•´ ê¸°ì¡´ GET APIë„ í˜¸ì¶œí•´ì•¼ í•  ìˆ˜ ìˆìŒ.
                // í•˜ì§€ë§Œ AI ìš”ì•½ì—ëŠ” "ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ"ì´ ìˆìœ¼ë¯€ë¡œ íŒŒì´ì°¨íŠ¸ëŠ” ê·¸ë¦´ ìˆ˜ ìˆìŒ.

                // í…Œì´ë¸”ì€ ë³„ë„ë¡œ ê°€ì ¸ì™€ì•¼ í•¨.
                // ê¸°ì¡´ ë¡œì§ ìœ ì§€í•˜ë©´ì„œ Summaryë§Œ êµì²´? -> ë„ˆë¬´ ë³µì¡í•¨.
                // ê°€ì¥ ì¢‹ì€ê±´ DailySummaryResponseì— ìƒì„¸ ë¦¬ìŠ¤íŠ¸ë„ í¬í•¨í•˜ëŠ” ê²ƒ.
                // í•˜ì§€ë©´ í˜„ì¬ DailySummaryResponseì—ëŠ” í¬í•¨ ì•ˆë¨.

                // ì¼ë‹¨ ìƒì„¸ ë‚´ì—­ë„ ë³´ì—¬ì¤˜ì•¼ í•˜ë¯€ë¡œ, ê¸°ì¡´ fetch ë¡œì§(ì¼ìë³„ ì¡°íšŒ)ì„ ì‚´ë ¤ì„œ í…Œì´ë¸”ì„ ì±„ìš°ê±°ë‚˜,
                // DailySummary APIê°€ ìƒì„¸ ë‚´ì—­ë„ ë¦¬í„´í•˜ë„ë¡ ìˆ˜ì •í•´ì•¼ í•¨.
                // ì‚¬ìš©ìê°€ "AI í‰ê°€ ë°ì´í„° ì €ì¥"ì„ ì›í–ˆìœ¼ë¯€ë¡œ, AI ë¶€ë¶„ì€ API ê²°ê³¼ë¥¼ ì“°ê³ , ë¦¬ìŠ¤íŠ¸ëŠ” ë³„ë„ ì¡°íšŒ í˜¹ì€ API ìˆ˜ì •.

                // API ìˆ˜ì •ë³´ë‹¤ëŠ” ì—¬ê¸°ì„œ ì¡°íšŒ í•œë²ˆ ë” í•˜ëŠ”ê²Œ ì•ˆì „.
                const [year, month] = date.split('-');

                fetch(`/api/v1/diary/${childId}/${year}/${month}/` + (chatId ? `?chat_id=${chatId}` : ''))
                    .then(res => res.json())
                    .then(detailData => {
                        const dailyEntries = (detailData.diary || []).filter(entry => entry.today === date);

                        const tableBody = document.getElementById('entry-table-body');
                        tableBody.innerHTML = '';
                        dailyEntries.forEach(entry => {
                            const row = document.createElement('tr');
                            const isIncome = entry.transaction_type === 'ìˆ˜ì…';
                            row.innerHTML = `
                    <td>${isIncome ? 'ğŸ’° ìˆ˜ì…' : 'ğŸ’¸ ì§€ì¶œ'}</td>
                    <td>${entry.diary_detail || '-'}</td>
                    <td><span class="category-badge">${entry.category || '-'}</span></td>
                    <td class="${isIncome ? 'income-amount' : 'expense-amount'}">
                        ${isIncome ? '+' : '-'}${parseFloat(entry.amount).toLocaleString('ko-KR')}ì›
                    </td>
                    `;
                            tableBody.appendChild(row);
                        });
                        if (dailyEntries.length > 0) tableEl.style.display = 'block';
                    });


                // íŒŒì´ ì°¨íŠ¸ (AI ë¶„ì„ ê²°ê³¼ ì‚¬ìš©)
                if (summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ && Object.keys(summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ).length > 0) {
                    // ë¬¸ìì—´ ê°’ ì²˜ë¦¬
                    const parsedCat = {};
                    for (const [k, v] of Object.entries(summary.ì¹´í…Œê³ ë¦¬ë³„_ì§€ì¶œ)) {
                        parsedCat[k] = parseFloat(v);
                    }
                    drawPieChart(parsedCat, categoryColors);
                    chartEl.style.display = 'block';
                }

                // AI í•œë§ˆë””
                const commentEl = document.getElementById('ai-comment-text');
                commentEl.textContent = summary.ì¼ì¼_í‰ê°€ || "AI í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.";
                aiEl.style.display = 'block';

            })
            .catch(err => {
                loadingEl.style.display = 'none';
                noDataEl.style.display = 'block';
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
            });
    }

    function drawPieChart(data, colors) {
        const chartContainer = document.getElementById('pie-chart');
        const legendContainer = document.getElementById('category-legend');
        chartContainer.innerHTML = '';
        legendContainer.innerHTML = '';

        const width = 280;
        const height = 280;
        const radius = Math.min(width, height) / 2 - 16;
        const innerRadius = 64;

        const svg = d3.select('#pie-chart')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2}, ${height / 2})`);

        const color = d3.scaleOrdinal()
            .domain(Object.keys(colors))
            .range(Object.values(colors));

        const pie = d3.pie().value(d => d[1]);
        const dataReady = pie(Object.entries(data));
        const total = Object.values(data).reduce((a, b) => a + b, 0);

        svg.selectAll('path')
            .data(dataReady)
            .join('path')
            .attr('d', d3.arc().innerRadius(innerRadius).outerRadius(radius))
            .attr('fill', d => colors[d.data[0]] || '#CC99FF')
            .attr('stroke', 'white')
            .style('stroke-width', '2px')
            .style('opacity', 0.85);

        // ë²”ë¡€ ìƒì„±
        Object.entries(data).forEach(([category, amount]) => {
            const percentage = ((amount / total) * 100).toFixed(1);
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <span class="legend-color" style="background-color: ${colors[category] || '#CC99FF'}"></span>
                <span>${category} (${percentage}%)</span>
            `;
            legendContainer.appendChild(legendItem);
        });
    }
});
</script>
{% endblock %}