{% extends 'base_children.html' %}



{% block title %}ëª¨ì•„ëª¨ì•„ :: ë˜‘ë˜‘í•œ ìš©ëˆ ê´€ë¦¬ ìŠµê´€{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ static('css/chatbot.css') }}">
<div class="chat-container">
  <div class="chat-history" id="chat-history"></div>
  <div class="chat-input-container" id="chat-input-container">
    <input type="hidden" id="childPk" value="{{ child_pk }}">
    <input type="hidden" id="userId" value="{{ user.id }}">
    <input type="hidden" id="username" value="{{ user.first_name }}">
    <input type="hidden" id="userProfileImage" value="{{ user_image }}">
    <div class="input-group">
      <!-- <button id="voice-button" class="voice-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
          <line x1="12" y1="19" x2="12" y2="23"></line>
          <line x1="8" y1="23" x2="16" y2="23"></line>
        </svg>
      </button> -->
      <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button id="send-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
<script>
  const chatHistory = document.getElementById('chat-history');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');
  const voiceButton = document.getElementById('voice-button');
  let isRecording = false;


  function getChildPkFromUrl() {
    const pathSegments = window.location.pathname.split('/');
    return pathSegments[pathSegments.length - 2];
  }

  function decodeHTMLEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}

  function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' });
  }

  function loadChatHistory() {
    const childPk = getChildPkFromUrl();
    fetch(`/api/v1/diary/chat/messages/${childPk}/`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(response => {
        if (response.status === 403) {  // ê¶Œí•œ ì—†ìŒ ìƒíƒœ (ì˜ëª»ëœ ì ‘ê·¼)
          window.location.href = '/access-error/';  // ì ‘ê·¼ ë¶ˆê°€ ì—ëŸ¬ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          return;
        }
        if (response.status === 401) {  // 401 Unauthorized ìƒíƒœ í™•ì¸
          window.location.href = '/login/';  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          return;
        }
        return response.json();
      })
      .then(data => {
        chatHistory.innerHTML = '';
  
        if (data && Array.isArray(data.response)) {
          data.response.forEach(message => {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-container');
            messageContainer.classList.add(message.type === 'USER' ? 'chat-right' : 'chat-left');
  
            const usernameElement = document.createElement('div');
            usernameElement.classList.add('chat-username');
  
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì¶”ê°€ ë¶€ë¶„
            const profileImage = document.createElement('img');
            profileImage.src = message.user_profile_image || message.ai_profile_image; // ê¸°ë³¸ ì´ë¯¸ì§€ ì„¤ì •
            profileImage.alt = 'Profile';
            profileImage.classList.add('profile-image'); // CSSë¡œ ë™ê·¸ë—ê²Œ ë§Œë“¤ê¸° ìœ„í•´ í´ë˜ìŠ¤ ì¶”ê°€
  
            // ì´ë¯¸ì§€ì™€ ì´ë¦„ì„ í•¨ê»˜ ì¶”ê°€
            usernameElement.appendChild(profileImage);
            usernameElement.appendChild(document.createTextNode(message.type === 'USER' ? message.username : message.ai_name));
  
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-bubble');
  
            // ë©”ì‹œì§€ ë‚´ìš© ì²˜ë¦¬
            let decodedContent = decodeHTMLEntities(message.content);
            const jsonBlockRegex = /```json[\s\S]*?```/g;
            decodedContent = decodedContent.replace(jsonBlockRegex, 'ìš©ëˆê¸°ì…ì¥ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆì–´ìš”!ğŸ˜€');


            let formattedContent = decodedContent.trim();
            if (formattedContent) {
              formattedContent = formattedContent
                .replace(/\n\n/g, '<br>')
                .replace(/\n/g, '<br>')
                .replace(/\"1\. /g, '<br> 1.')
                .replace(/\"2\. /g, '<br> 2.')
                .replace(/---/g, '')
                .replace(/\? /g, '?<br>')
                .replace(/\"/g, "")
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .trim();
  
              const sanitizeConfig = {
                ALLOWED_TAGS: ['br', 'strong'],
                KEEP_CONTENT: true
              };
  
              const sanitizedContent = DOMPurify.sanitize(formattedContent, sanitizeConfig);
  
              messageElement.innerHTML = sanitizedContent;
            }
  
              const timestampElement = document.createElement('div');
              timestampElement.classList.add('timestamp');
              timestampElement.textContent = formatTimestamp(message.timestamp);
  
              messageContainer.appendChild(usernameElement);
              messageContainer.appendChild(messageElement);
              messageContainer.appendChild(timestampElement);
              chatHistory.appendChild(messageContainer);
          });
          chatHistory.scrollTop = chatHistory.scrollHeight;
        } else {
          console.error('Expected an array in `data.response` but got:', data.response);
        }
      })
      .catch(error => {
        console.error('Fetch error:', error);
      });
  }

  function sendMessage() {
    const message = chatInput.value.trim();
    if (message) {
        const childPk = getChildPkFromUrl();
        const username = document.getElementById('username').value; // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const userProfileImage = document.getElementById('userProfileImage').value;
        // ì…ë ¥ì°½ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
        chatInput.disabled = true;  
        chatInput.value = '';  
        chatInput.placeholder = 'ëª¨ì•„ëª¨ì•„ê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...ğŸ¤”';  

        // ìœ ì € ë©”ì‹œì§€ë¥¼ ë¨¼ì € í™”ë©´ì— ì¶”ê°€
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container', 'chat-right');
        
        const usernameElement = document.createElement('div');
        usernameElement.classList.add('chat-username');
        
        const profileImage = document.createElement('img');
        profileImage.src = userProfileImage; // ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ URL
        profileImage.alt = 'Profile';
        profileImage.classList.add('profile-image');
        
        usernameElement.appendChild(profileImage);
        usernameElement.appendChild(document.createTextNode(username)); // ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€
        
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-bubble');
        messageElement.innerHTML = message.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬

        const timestampElement = document.createElement('div');
        timestampElement.classList.add('timestamp');
        timestampElement.textContent = formatTimestamp(new Date()); // í˜„ì¬ ì‹œê°„ í‘œì‹œ

        messageContainer.appendChild(usernameElement);
        messageContainer.appendChild(messageElement);
        messageContainer.appendChild(timestampElement);
        chatHistory.appendChild(messageContainer);
        chatHistory.scrollTop = chatHistory.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ì´ë™

        // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
        fetch('/api/v1/diary/chat/', {
            credentials: 'include',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message, child_pk: childPk })
        })
        .then(response => response.json())
        .then(data => {
            loadChatHistory(); // AIì˜ ì‘ë‹µê³¼ ê¸°ì¡´ ê¸°ë¡ ë¡œë“œ
            
            // ì…ë ¥ì°½ í™œì„±í™” ë° ì›ë˜ ìƒíƒœë¡œ ë³µì›
            chatInput.disabled = false;  
            chatInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';  
            chatInput.focus();  
        })
        .catch(error => {
            console.error('Error:', error);
            
            // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì…ë ¥ì°½ì„ ë‹¤ì‹œ í™œì„±í™”
            chatInput.disabled = false;
            chatInput.placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';  
        });
    }
}


  document.addEventListener('DOMContentLoaded', function () {
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    // voiceButton.addEventListener('click', toggleVoiceRecording);

    loadChatHistory();
    // setInterval(loadChatHistory, 5000);
  });

  function adjustChatHistoryHeight() {
    const chatInputContainer = document.getElementById('chat-input-container');
    const chatHistory = document.getElementById('chat-history');
    const chatInputHeight = chatInputContainer.offsetHeight;
    chatHistory.style.height = `calc(100vh - ${chatInputHeight}px - 60px)`; // 60pxëŠ” ëª¨ì•„ëª¨ì•„ ë°°ë„ˆ ë†’ì´
  }

  window.addEventListener('load', adjustChatHistoryHeight);
  window.addEventListener('resize', adjustChatHistoryHeight);
</script>
{% endblock %}
